var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),Input;!function(t){!function(t){var e;!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE",t[t.NUM_1=49]="NUM_1",t[t.NUM_2=50]="NUM_2",t[t.NUM_3=51]="NUM_3",t[t.NUM_4=52]="NUM_4",t[t.NUM_5=53]="NUM_5",t[t.C=67]="C"}(e=t.KEY||(t.KEY={}));var n;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t[t.ACTION=4]="ACTION"}(n=t.META_KEY||(t.META_KEY={})),t.KEY_BIND=[],t.KEY_BIND[n.UP]=[e.W,e.UP],t.KEY_BIND[n.DOWN]=[e.S,e.DOWN],t.KEY_BIND[n.LEFT]=[e.A,e.LEFT],t.KEY_BIND[n.RIGHT]=[e.D,e.RIGHT],t.KEY_BIND[n.ACTION]=[e.SPACE,e.ENTER];for(var i=[],s=[],r=[],o=0;o<256;o++)s[o]=!0;t.isDown=function(t){return i[t]},t.wasDown=function(t){var e=r[t];return r[t]=!1,e},t.clearInputQueue=function(){for(var t in r)r[t]=!1},t.keyDown=function(t){var e=t.which;i[e]=!0,s[e]&&(r[e]=!0),s[e]=!1},t.keyUp=function(t){var e=t.which;i[e]=!1,s[e]=!0},t.isBindDown=function(e){for(var n=!1,s=0,r=t.KEY_BIND[e];s<r.length;s++){var o=r[s];n=n||i[o]}return n},t.wasBindDown=function(e){for(var n=!1,i=0,s=t.KEY_BIND[e];i<s.length;i++){var o=s[i];n=n||r[o],r[o]=!1}return n}}(t.KB||(t.KB={}))}(Input||(Input={}));var Game=function(){function t(t,e,n){this._canvas=e,this._window=t,this._audioContext=n,ImageCache.Loader.add("sheet","./sheet.png"),ImageCache.Loader.load(this.init.bind(this))}return t.prototype.init=function(){this.engine=new Engine(this._canvas),this.bindings(),this.engine.gsm.register("main-menu",new MainMenu(this)),this.engine.gsm.register("game-screen",new GameScreen(this)),this.engine.gsm.push("main-menu"),this.engine.run()},t.prototype.bindings=function(){this._window.addEventListener("resize",this.onResize.bind(this),!1),this.onResize(),this._window.onkeydown=Input.KB.keyDown,this._window.onkeyup=Input.KB.keyUp,this._window.onblur=this.engine.pause.bind(this.engine),this._window.onfocus=this.engine.unpause.bind(this.engine),this.audioEngine=new AudioEngine(this._audioContext)},t.prototype.onResize=function(){var t=window.innerWidth/this._canvas.width,e=window.innerHeight/this._canvas.height,n=0|Math.min(t,e);n=n<=0?1:n;var i=[this._canvas.width*n,this._canvas.height*n],s=[(window.innerWidth-i[0])/2,(window.innerHeight-i[1])/2],r=document.getElementById("stage"),o="translate("+~~s[0]+"px, "+~~s[1]+"px) scale("+~~n+")";r.style.transform=o,r.style.webkitTransform=o},t}();!function(t){t.GAME_PIXEL_WIDTH=512,t.GAME_PIXEL_HEIGHT=288,t.TILE_SIZE=8}(Game||(Game={}));var GameState=function(){function t(t){this.game=t,this.redraw=!0,this.requestingClear=!1}return t.prototype.transitionIn=function(){this.redraw=!0,this.update(0)},t.prototype.transitionOut=function(){this.redraw=!0,this.update(0)},t}(),GameStateManager=function(){function t(){this.stateCollection={},this.stateStack=[]}return t.prototype.register=function(t,e){this.stateCollection[t]=e},Object.defineProperty(t.prototype,"current",{get:function(){return this.stateStack[this.stateStack.length-1]},enumerable:!0,configurable:!0}),t.prototype.push=function(t){this.current&&this.current.transitionOut(),this.stateStack.push(this.stateCollection[t]),this.current&&this.current.transitionIn()},t.prototype.pop=function(){this.current&&this.current.transitionOut(),this.stateStack.pop(),this.current&&this.current.transitionIn()},t}(),Engine=function(){function t(t){this.clearScreen=!1,this.redraw=!1,this.systemPause=!1,this.screen=t,this.ctx=this.screen.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=this.screen.width,this.buffer.height=this.screen.height,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1,this.gsm=new GameStateManager}return t.prototype.update=function(t){this.systemPause||this.gsm.current.update(t)},t.prototype.draw=function(){(this.clearScreen||this.gsm.current.requestingClear)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.bufferCtx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=this.gsm.current.requestingClear=!1),this.systemPause||!this.redraw&&!this.gsm.current.redraw?this.systemPause&&this.redraw&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,Game.GAME_PIXEL_WIDTH,Game.GAME_PIXEL_HEIGHT),this.ctx.globalAlpha=1,this.redraw=this.gsm.current.redraw=!1):(this.gsm.current.draw(this.bufferCtx),this.ctx.drawImage(this.buffer,0,0,Game.GAME_PIXEL_WIDTH,Game.GAME_PIXEL_HEIGHT,0,0,Game.GAME_PIXEL_WIDTH,Game.GAME_PIXEL_HEIGHT),this.redraw=this.gsm.current.redraw=!1)},t.prototype.loop=function(){var t=window.performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},t.prototype.run=function(){this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},t.prototype.stop=function(){window.cancelAnimationFrame(this.loopHandle)},t.prototype.pause=function(){this.systemPause=!0,this.redraw=!0},t.prototype.unpause=function(){this.systemPause=!1,this.gsm.current.redraw=this.clearScreen=!0},t}(),AudioEngine=function(){function t(t){this.audioContext=t}return t.prototype.beep=function(t){var e=this.audioContext,n=e.createOscillator(),i=e.createGain(),s=t.vol||1;n.type=t.shape,n.frequency.setValueAtTime(t.freq1,e.currentTime),n.frequency.exponentialRampToValueAtTime(t.freq2,e.currentTime+t.dur/2),n.frequency.exponentialRampToValueAtTime(t.freq1,e.currentTime+t.dur),i.gain.setValueAtTime(s,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+t.dur),n.connect(i),i.connect(e.destination),n.start(e.currentTime),n.stop(e.currentTime+t.dur)},t}(),Beep=function(){return function(t,e,n,i,s){this.freq1=t,this.freq2=e,this.shape=n,this.dur=i,this.vol=s}}(),Component=function(){return function(t){this.name=t}}(),Dm=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.w=t,this.h=e}return t.from=function(e,n){return new t(e,n)},t}(),Pt=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.from=function(e,n){return new t(e,n)},t}(),ECS;!function(t){var e=function(t){function e(e){var n=e.w,i=void 0===n?0:n,s=e.h,r=void 0===s?0:s,o=t.call(this,"aabb")||this;return o.value=new Dm(i,r),o}return __extends(e,t),e}(Component);t.AABB=e;var n=function(t){function e(e){var n=e.x,i=void 0===n?0:n,s=e.y,r=void 0===s?0:s,o=t.call(this,"position")||this;return o.value=new Pt(i,r),o}return __extends(e,t),e}(Component);t.Pos=n;var i=function(t){function e(e){var n=t.call(this,"style")||this;return n.value=e,n}return __extends(e,t),e}(Component);t.Style=i;var s=function(t){function e(e){var n=t.call(this,"sprite")||this;return n.value=e,n}return __extends(e,t),e}(Component);t.Sprite=s;var r=function(t){function e(e,n){var i=t.call(this,e)||this;return i.value=n,i}return __extends(e,t),e}(Component);t.Tag=r;var o=function(t){function e(e,n){var i=t.call(this,e)||this;return i.value=n,i}return __extends(e,t),e}(Component);t.Flag=o}(ECS||(ECS={}));var GameEntity=function(){function t(){return this.components={},t.autoID||(t.autoID=0),this.id=t.autoID++,this}return t.prototype.addComponent=function(t){return this.components[t.name]=t,this},t}(),ImageCache;!function(t){var e={};t.getTexture=function(t){return e[t]};var n={},i=0;!function(t){t.add=function(t,e){n[t]=e,i++},t.load=function(t){var s={counter:0,loadCount:0,callback:t};for(var r in n)e[r]=new Image,e[r].src=n[r],e[r].onload=function(t){t.counter++===t.loadCount&&t.callback()}.bind(this,s),delete n[r];i=0}}(t.Loader||(t.Loader={}))}(ImageCache||(ImageCache={}));var SpriteSheet=function(){function t(t,e,n,i,s,r){void 0===i&&(i=0),void 0===s&&(s=new Dm(0,0)),void 0===r&&(r=new Pt(0,0)),this.sprites=[],this.name=e,this.offset=r,this.subsheet=s,this.tileSize=n,this.gutter=i,this.image=ImageCache.getTexture(t),this.storeSprites()}return t.prototype.reColourize=function(t,e,n,i,s){for(var r=this.sprites[t].getContext("2d").getImageData(0,0,this.tileSize,this.tileSize),o=0;o<this.tileSize*this.tileSize*4;o+=4)r.data[o]=e||r.data[o],r.data[o+1]=n||r.data[o+1],r.data[o+2]=i||r.data[o+2],r.data[o+3]=s||r.data[o+3];var a=document.createElement("canvas");return a.width=a.height=this.tileSize,a.getContext("2d").putImageData(r,0,0),a},t.prototype.storeSprites=function(t){void 0===t&&(t=null),this.spritesPerRow=0===this.subsheet.w||0===this.subsheet.h?this.image.width/this.tileSize:this.subsheet.w,this.spritesPerCol=0===this.subsheet.w||0===this.subsheet.h?this.image.height/this.tileSize:this.subsheet.h;for(var e,n=0;n<this.spritesPerCol;n++)for(var i=0;i<this.spritesPerRow;i++)(e=this.sprites[i+n*this.spritesPerRow]=document.createElement("canvas")).width=this.tileSize,e.height=this.tileSize,e.getContext("2d").drawImage(this.image,(this.tileSize+this.gutter)*i+this.offset.x,(this.tileSize+this.gutter)*n+this.offset.y,this.tileSize,this.tileSize,0,0,this.tileSize,this.tileSize)},t}(),SpriteSheetManager;!function(t){var e={};t.storeSheet=function(t){e[t.name]=t},t.spriteSheet=function(t){return e[t]}}(SpriteSheetManager||(SpriteSheetManager={}));var GameScreen=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.transitionIn=function(){this.requestingClear=!0,t.prototype.transitionIn.call(this)},e.prototype.transitionOut=function(){t.prototype.transitionOut.call(this)},e.prototype.update=function(t){Input.KB.wasBindDown(Input.KB.META_KEY.ACTION)&&this.game.engine.gsm.pop(),Input.KB.wasBindDown(Input.KB.META_KEY.UP)&&this.game.audioEngine.beep(new Beep(300,2e3,"square",1,1))},e.prototype.draw=function(t){this.redraw&&(t.globalAlpha=1,t.fillStyle="blue",t.fillRect(0,0,~~Game.GAME_PIXEL_WIDTH,~~Game.GAME_PIXEL_HEIGHT),t.globalAlpha=.75,t.textAlign="center",t.fillStyle=t.strokeStyle="yellow",t.lineWidth=2,t.fillText("This is the game screen, baby.",~~(Game.GAME_PIXEL_WIDTH/2|0),64))},e}(GameState),MainMenu=function(t){function e(e){var n=t.call(this,e)||this;return n.selectedIndex=0,n.menuOptions=["Start","Options","Exit"],n}return __extends(e,t),e.prototype.transitionIn=function(){this.requestingClear=!0,t.prototype.transitionIn.call(this)},e.prototype.transitionOut=function(){this.requestingClear=!0,t.prototype.transitionIn.call(this)},e.prototype.update=function(t){if(Input.KB.wasBindDown(Input.KB.META_KEY.ACTION))switch(this.selectedIndex){case 0:this.game.engine.gsm.push("game-screen");break;case 1:break;default:window.location.reload()}Input.KB.wasBindDown(Input.KB.META_KEY.DOWN)&&(this.selectedIndex=(this.selectedIndex+1)%this.menuOptions.length,this.redraw=this.requestingClear=!0),Input.KB.wasBindDown(Input.KB.META_KEY.UP)&&(0===this.selectedIndex?this.selectedIndex=this.menuOptions.length-1:this.selectedIndex=(this.selectedIndex-1)%3,this.redraw=this.requestingClear=!0)},e.prototype.draw=function(t){if(this.redraw){t.globalAlpha=1,t.font="18px Verdana",t.textAlign="center",t.fillStyle=t.strokeStyle="black",t.lineWidth=2,t.fillText("js13k 2017",~~(Game.GAME_PIXEL_WIDTH/2|0),64);for(var e=0;e<this.menuOptions.length;e++)t.fillText(this.menuOptions[e],~~(Game.GAME_PIXEL_WIDTH/2|0),~~((0|Game.GAME_PIXEL_HEIGHT)-36*this.menuOptions.length+36*e));t.strokeRect(~~(Game.GAME_PIXEL_WIDTH/2-75),~~(Game.GAME_PIXEL_HEIGHT-36*this.menuOptions.length+36*this.selectedIndex-18),150,24)}},e}(GameState);