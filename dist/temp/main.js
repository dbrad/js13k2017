function createPlayer(){var e=new GameEntity;return e.addComponent(new cP("pos")),e.addComponent(new cP("move")),e.addComponent(new cSound("move",new Beep(50,5,"sine",.25,1))),e.addComponent(new cTimer("move",125)),e.addComponent(new cLight(new Light(new Pt,.75,5))),e.addComponent(new cFlag("input",!1)),e.addComponent(new cSprite(SSM.spriteSheet("sprites").sprites[0])),e}function createGuidingLight(){var e=new GameEntity;return e.addComponent(new cP("pos")),e.addComponent(new cP("origin")),e.addComponent(new cTimer("move",150)),e.addComponent(new cLight(new Light(new Pt,.35,7))),e.addComponent(new cSprite(SSM.spriteSheet("guide").sprites[0])),e}function createMarker(e,t){void 0===t&&(t=0);var n=new GameEntity;n.addComponent(new cP("pos"));var i=new cSprite(SSM.spriteSheet("marker").sprites[e]);return n.addComponent(new cLight(new Light(new Pt,.15,4))),i.r=t,n.addComponent(i),n}function createSpawner(e){var t=new GameEntity;return t.addComponent(new cP("pos")),t.addComponent(new cTag("type",e)),t.addComponent(new cFlag("done",!1)),t}function createSwitch(){var e=new GameEntity;return e.addComponent(new cP("pos")),e.addComponent(new cFlag("active",!1)),e.addComponent(new cSprite(SSM.spriteSheet("guide").sprites[1])),e.addComponent(new cTag("type","switch")),e.addComponent(new cSound("interact",new Beep(1900,1,"square",.1,1))),e}function createObject(e){var t=new GameEntity;t.addComponent(new cP("pos")),t.addComponent(new cSprite(SSM.spriteSheet("objects").sprites[e])),t.addComponent(new cSound("collide",new Beep(50,5,"sine",.25,1)));var n=function(e){switch(e){case 0:return"exit";case 1:return"chest";case 2:return"gold";default:return"unknown"}}(e);return t.addComponent(new cTag("type",n)),t}function input(e){var t,n=e.components["p-move"].value;return n.x=n.y=0,Input.KB.isBindDown(Input.KB.META_KEY.UP)&&(n.y-=1,t=!0),Input.KB.isBindDown(Input.KB.META_KEY.DOWN)&&(n.y+=1,t=!0),Input.KB.isBindDown(Input.KB.META_KEY.LEFT)&&(n.x-=1,t=!0),Input.KB.isBindDown(Input.KB.META_KEY.RIGHT)&&(n.x+=1,t=!0),t}function exit(e){var t=Game.gd.p.indexOf(e);-1!==t&&(Game.gd.removePlayer(Pt.from(e.components["p-pos"].value)),delete Game.gd.p[t],Game.gd.players-=1)}function activate(e){var t=e.components;t.active&&!1===t.active.value&&(t.active.value=!0,t.sprite.value=SSM.spriteSheet("guide").sprites[2],Game.i.ae.beep(t["s-interact"].value),Game.gd.addSpawner(createSpawner("guide"),Pt.from(t["p-pos"].value)))}function spawn(e){var t=e.components,n=Pt.from(t["p-pos"].value);switch(t.type.value){case"player":Game.gd.addPlayer(createPlayer(),n);break;case"guide":Game.gd.addGuide(createGuidingLight(),n)}var i=Game.gd.s.indexOf(e);-1!==i&&delete Game.gd.s[i]}function pickup(e){var t=Game.gd.o.indexOf(e);if(-1!==t)switch(Game.gd.removeObject(Pt.from(e.components["p-pos"].value)),delete Game.gd.o[t],e.components.type.value){case"chest":Game.gd.score+=1e5;break;case"gold":Game.gd.score+=1e3}}function collision(e,t){var n=e.components,i=n["p-pos"].value,s=n["p-move"].value,a=new Pt(s.x,s.y),r=!1;return t.m[i.x+s.x+(i.y+s.y)*t.s.w]&TMASK.W&&!Game.gd.playerAt(new Pt(i.x+s.x,i.y+s.y))||(s.x=s.y=0,r=!0),0!==a.x&&t.m[i.x+a.x+i.y*t.s.w]&TMASK.W&&!Game.gd.playerAt(new Pt(i.x+a.x,i.y))?(s.x=a.x,r=!1):0!==a.y&&t.m[i.x+(i.y+a.y)*t.s.w]&TMASK.W&&!Game.gd.playerAt(new Pt(i.x,i.y+a.y))&&(s.y=a.y,r=!1),r}function animate(e){var t=e.components,n=t.sprite,i=t["p-move"].value;0===i.x&&0===i.y||(1===i.x?n.r+=90:-1===i.x?n.r-=90:-1!==i.y&&1!==i.y||n.r%180==0?-1!==i.y&&1!==i.y||n.r%180!=0||(n.r+=180):n.r=0,1===Math.abs(n.r%360)&&(n.r=0))}function movement(e){var t=e.components,n=t["p-pos"],i=t["p-move"].value;if(0!==i.x||0!==i.y){var s=Pt.from(n.value);return n.value.x+=i.x,n.value.y+=i.y,Game.gd.movePlayer(s,n.value),i.x=i.y=0,!0}return!1}function guideMove(e){var t=e.components,n=Game.gd.exit.components["p-pos"].value,i=t["p-pos"].value,s=n.x-i.x,a=n.y-i.y,r=Math.abs(s),o=Math.abs(a);0==s&&0==a?t["p-pos"].value=Pt.from(t["p-origin"].value):0!==r&&0!==o?(i.x+=s>0?1:-1,i.y+=a>0?1:-1):0!==r?i.x+=s>0?1:-1:0!==o&&(i.y+=a>0?1:-1);var h=t.sprite;h.r+=15,360==h.r&&(h.r=0)}function drawEnt(e,t,n){var i=t.components["p-pos"].value;if(i.x>=n.p.x&&i.x<n.p.x+n.s.w&&i.y>=n.p.y&&i.y<n.p.y+n.s.h){var s=t.components.sprite,a=s.value;e.save(),e.translate(~~((i.x-n.p.x)*Game.T_S*2)+Game.T_S,~~((i.y-n.p.y)*Game.T_S*2)+Game.T_S),e.rotate(s.r*Math.PI/180),e.drawImage(a,0,0,Game.T_S,Game.T_S,-Game.T_S,-Game.T_S,2*Game.T_S,2*Game.T_S),e.restore()}}function drawSpr(e,t,n,i,s){void 0===i&&(i=1),void 0===s&&(s=0),e.save(),e.translate(~~(n.x*Game.T_S*i),~~(n.y*Game.T_S*i)),e.rotate(s*Math.PI/180),e.drawImage(t,0,0,Game.T_S,Game.T_S,-Game.T_S,-Game.T_S,Game.T_S*i,Game.T_S*i),e.restore()}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function randomized(e,t){void 0===t&&(t=!0);var n=e,i=t,s=shuffle(n);return function(){if(0===s.length&&i)s=shuffle(n);else if(0===s.length&&!i)return;return s.pop()}}function shuffle(e){for(var t,n,i=e.length,s=e.slice();0!==i;)n=Math.floor(Math.random()*i),t=s[i-=1],s[i]=s[n],s[n]=t;return s}var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),Input;!function(e){!function(e){var t;!function(e){e[e.A=65]="A",e[e.D=68]="D",e[e.W=87]="W",e[e.S=83]="S",e[e.LEFT=37]="LEFT",e[e.RIGHT=39]="RIGHT",e[e.UP=38]="UP",e[e.DOWN=40]="DOWN",e[e.ENTER=13]="ENTER",e[e.SPACE=32]="SPACE",e[e.NUM_1=49]="NUM_1",e[e.NUM_2=50]="NUM_2",e[e.NUM_3=51]="NUM_3",e[e.NUM_4=52]="NUM_4",e[e.NUM_5=53]="NUM_5",e[e.C=67]="C",e[e.ESC=27]="ESC"}(t=e.KEY||(e.KEY={}));var n;!function(e){e[e.UP=0]="UP",e[e.DOWN=1]="DOWN",e[e.LEFT=2]="LEFT",e[e.RIGHT=3]="RIGHT",e[e.ACTION=4]="ACTION"}(n=e.META_KEY||(e.META_KEY={})),e.KEY_BIND=[],e.KEY_BIND[n.UP]=[t.W,t.UP],e.KEY_BIND[n.DOWN]=[t.S,t.DOWN],e.KEY_BIND[n.LEFT]=[t.A,t.LEFT],e.KEY_BIND[n.RIGHT]=[t.D,t.RIGHT],e.KEY_BIND[n.ACTION]=[t.SPACE,t.ENTER];for(var i=[],s=[],a=[],r=0;r<256;r++)s[r]=!0;e.isDown=function(e){return i[e]},e.wasDown=function(e){var t=a[e];return a[e]=!1,t},e.clearInputQueue=function(){for(var e in a)a[e]=!1},e.keyDown=function(e){var t=e.which;i[t]=!0,s[t]&&(a[t]=!0),s[t]=!1},e.keyUp=function(e){var t=e.which;i[t]=!1,s[t]=!0},e.isBindDown=function(t){for(var n=!1,s=0,a=e.KEY_BIND[t];s<a.length;s++){var r=a[s];n=n||i[r]}return n},e.wasBindDown=function(t){for(var n=!1,i=0,s=e.KEY_BIND[t];i<s.length;i++){var r=s[i];n=n||a[r],a[r]=!1}return n}}(e.KB||(e.KB={}))}(Input||(Input={}));var Game=function(){function e(){}return Object.defineProperty(e,"i",{get:function(){return e._i||(e._i=new e),e._i},enumerable:!0,configurable:!0}),Object.defineProperty(e,"gd",{get:function(){return e.i._gc||(e.i._gc=new GameData),e.i._gc},enumerable:!0,configurable:!0}),e.prototype.init=function(e,t,n){this._c=t,this._w=e,this._ac=n,ImageCache.Loader.add("sheet","./sheet.png"),ImageCache.Loader.load(this.done.bind(this))},e.prototype.done=function(){this.e=new Engine(this._c),this.bindings(),this.e.gsm.reg("main-menu",new MainMenu),this.e.gsm.reg("game-screen",new GameScreen),this.e.gsm.reg("marker-menu",new MarkerMenu),this.e.gsm.push("main-menu"),this.e.run()},e.prototype.bindings=function(){this._w.addEventListener("resize",this.onResize.bind(this),!1),this.onResize(),this._w.onkeydown=Input.KB.keyDown,this._w.onkeyup=Input.KB.keyUp,this._w.onblur=this.e.pause.bind(this.e),this._w.onfocus=this.e.unpause.bind(this.e),this.ae=new AudioEngine(this._ac),SSM.storeSheet(new SpriteSheet("sheet","sprites",8,0,new Dm(5,1))),SSM.storeSheet(new SpriteSheet("sheet","marker",8,0,new Dm(2,1),new Pt(8,0))),SSM.storeSheet(new SpriteSheet("sheet","floor",8,0,new Dm(3,1),new Pt(24,0))),SSM.storeSheet(new SpriteSheet("sheet","wall",8,0,new Dm(4,1),new Pt(48,0))),SSM.storeSheet(new SpriteSheet("sheet","guide",8,0,new Dm(3,1),new Pt(0,8))),SSM.storeSheet(new SpriteSheet("sheet","objects",8,0,new Dm(3,1),new Pt(24,8)))},e.prototype.onResize=function(){var e=window.innerWidth/this._c.width,t=window.innerHeight/this._c.height,n=0|Math.min(e,t);n=n<=0?1:n;var i=[this._c.width*n,this._c.height*n],s=[(window.innerWidth-i[0])/2,(window.innerHeight-i[1])/2],a=document.getElementById("stage"),r="translate("+~~s[0]+"px, "+~~s[1]+"px) scale("+~~n+")";a.style.transform=r,a.style.webkitTransform=r},e}();!function(e){e.P_W=512,e.P_H=288,e.T_W=64,e.T_H=36,e.T_S=8}(Game||(Game={}));var GameState=function(){function e(){this.redraw=!0,this.requestingClear=!1}return e.prototype.transitionIn=function(){this.redraw=!0,this.update(0)},e.prototype.transitionOut=function(){this.redraw=!0,this.update(0)},e}(),GameStateManager=function(){function e(){this.stateCollection={},this.stateStack=[]}return e.prototype.reg=function(e,t){this.stateCollection[e]=t},Object.defineProperty(e.prototype,"cur",{get:function(){return this.stateStack[this.stateStack.length-1]},enumerable:!0,configurable:!0}),e.prototype.push=function(e){this.cur&&this.cur.transitionOut(),this.stateStack.push(this.stateCollection[e]),this.cur&&this.cur.transitionIn()},e.prototype.pop=function(){this.cur&&this.cur.transitionOut(),this.stateStack.pop(),this.cur&&this.cur.transitionIn()},e}(),Engine=function(){function e(e){this.clearScreen=!1,this.redraw=!1,this.systemPause=!1,this.screen=e,this.ctx=this.screen.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=this.screen.width,this.buffer.height=this.screen.height,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1,this.bufferCtx.webkitImageSmoothingEnabled=!1,this.gsm=new GameStateManager}return e.prototype.update=function(e){this.systemPause||this.gsm.cur.update(e)},e.prototype.draw=function(){(this.clearScreen||this.gsm.cur.requestingClear)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.bufferCtx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=this.gsm.cur.requestingClear=!1),this.systemPause||!this.redraw&&!this.gsm.cur.redraw?this.systemPause&&this.redraw&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,Game.P_W,Game.P_H),this.ctx.globalAlpha=1,this.redraw=this.gsm.cur.redraw=!1):(this.bufferCtx.globalAlpha=1,this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1,this.bufferCtx.webkitImageSmoothingEnabled=!1,this.gsm.cur.draw(this.bufferCtx),this.ctx.globalAlpha=1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.drawImage(this.buffer,0,0,Game.P_W,Game.P_H,0,0,Game.P_W,Game.P_H),this.redraw=this.gsm.cur.redraw=!1)},e.prototype.loop=function(){var e=window.performance.now(),t=e-this.then;this.then=e,this.update(t),this.draw(),this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},e.prototype.run=function(){this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},e.prototype.stop=function(){window.cancelAnimationFrame(this.loopHandle)},e.prototype.pause=function(){this.systemPause=!0,this.redraw=!0},e.prototype.unpause=function(){this.systemPause=!1,this.gsm.cur.redraw=this.clearScreen=!0},e}(),AudioEngine=function(){function e(e){this.audioContext=e}return e.prototype.beep=function(e){var t=this.audioContext,n=t.createOscillator(),i=t.createGain(),s=e.vol||1;n.type=e.shape,n.frequency.setValueAtTime(e.freq1,t.currentTime),n.frequency.exponentialRampToValueAtTime(e.freq2,t.currentTime+e.dur/2),n.frequency.exponentialRampToValueAtTime(e.freq1,t.currentTime+e.dur),i.gain.setValueAtTime(s,t.currentTime),i.gain.exponentialRampToValueAtTime(.001,t.currentTime+e.dur),n.connect(i),i.connect(t.destination),n.start(t.currentTime),n.stop(t.currentTime+e.dur)},e}(),Beep=function(){return function(e,t,n,i,s){this.freq1=e,this.freq2=t,this.shape=n,this.dur=i,this.vol=s}}(),Component=function(){return function(e){this.name=e}}(),GameEntity=function(){function e(){return this.components={},e.autoID||(e.autoID=0),this.id=e.autoID++,this}return e.prototype.addComponent=function(e){return this.components[e.name]=e,this},e}(),ImageCache;!function(e){var t={};e.getTexture=function(e){return t[e]};var n={},i=0;!function(e){e.add=function(e,t){n[e]=t,i++},e.load=function(e){var s={counter:0,loadCount:0,callback:e};for(var a in n)t[a]=new Image,t[a].src=n[a],t[a].onload=function(e){e.counter++===e.loadCount&&e.callback()}.bind(this,s),delete n[a];i=0}}(e.Loader||(e.Loader={}))}(ImageCache||(ImageCache={}));var Pt=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t}return e.from=function(t){var n=new e;return n.x=t.x,n.y=t.y,n},e}(),Dm=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.w=e,this.h=t}return e.from=function(t,n){return new e(t,n)},e}(),SpriteSheet=function(){function e(e,t,n,i,s,a){void 0===i&&(i=0),void 0===s&&(s=new Dm(0,0)),void 0===a&&(a=new Pt(0,0)),this.sprites=[],this.name=t,this.offset=a,this.subsheet=s,this.tileSize=n,this.gutter=i,this.image=ImageCache.getTexture(e),this.storeSprites()}return e.prototype.reColourize=function(e,t,n,i,s){for(var a=this.sprites[e].getContext("2d").getImageData(0,0,this.tileSize,this.tileSize),r=0;r<this.tileSize*this.tileSize*4;r+=4)a.data[r]=t||a.data[r],a.data[r+1]=n||a.data[r+1],a.data[r+2]=i||a.data[r+2],a.data[r+3]=s||a.data[r+3];var o=document.createElement("canvas");return o.width=o.height=this.tileSize,o.getContext("2d").putImageData(a,0,0),o},e.prototype.storeSprites=function(e){void 0===e&&(e=null),this.spritesPerRow=0===this.subsheet.w||0===this.subsheet.h?this.image.width/this.tileSize:this.subsheet.w,this.spritesPerCol=0===this.subsheet.w||0===this.subsheet.h?this.image.height/this.tileSize:this.subsheet.h;for(var t,n=0;n<this.spritesPerCol;n++)for(var i=0;i<this.spritesPerRow;i++){var s=(t=this.sprites[i+n*this.spritesPerRow]=document.createElement("canvas")).getContext("2d");s.mozImageSmoothingEnabled=s.webkitImageSmoothingEnabled=s.imageSmoothingEnabled=!1,t.width=this.tileSize,t.height=this.tileSize,s.drawImage(this.image,(this.tileSize+this.gutter)*i+this.offset.x,(this.tileSize+this.gutter)*n+this.offset.y,this.tileSize,this.tileSize,0,0,this.tileSize,this.tileSize)}},e}(),SSM;!function(e){var t={};e.storeSheet=function(e){t[e.name]=e},e.spriteSheet=function(e){return t[e]}}(SSM||(SSM={}));var GameData=function(){function e(){this.p=[],this.m=[],this.o=[],this.s=[],this.g=[],this.lm=[],this.lights=[],this.score=0,this.players=0,this.markers=0,this.P_OFF=26,this.O_OFF=16,this.M_OFF=8}return e.prototype.setupGame=function(e){var t,n,i;switch(e){case diff.EASY:t=2,n=2,this.markers=10,i=new Dm(100,100);break;case diff.NORMAL:t=2,n=4,this.markers=25,i=new Dm(175,175);break;case diff.HARD:t=4,n=8,this.markers=50,i=new Dm(250,250);break;case diff.VHARD:t=8,n=16,this.markers=100,i=new Dm(500,500);break;default:t=1,n=2,this.markers=10,i=new Dm(50,50)}this.players=t,this.p.length=this.o.length=this.m.length=this.g.length=this.s.length=0,this.buildObjBank(t,n,i),this.l=new Level(i),this.l.generate()},e.prototype.buildObjBank=function(e,t,n){for(var i=[0],s=~~(n.w*n.h*.001),a=~~(.25*(s-e-t)),r=~~(s-e-t-a),o=0;o<e;o++)i.push(1);for(o=0;o<t;o++)i.push(2);for(o=0;o<a;o++)i.push(3);for(o=0;o<r;o++)i.push(4);this.objectBank=randomized(i,!1)},e.prototype.addRandObj=function(e,t){var n=parseInt(this.objectBank()),i=new Pt(randomInt(e.x+1,e.x+t.w-2),randomInt(e.y+1,e.y+t.h-2));if(void 0!==n)switch(n){case 0:this.exit=createObject(0),this.addObject(this.exit,i);break;case 1:this.addSpawner(createSpawner("player"),i);break;case 2:this.addObject(createSwitch(),i);break;case 3:this.addObject(createObject(1),i);break;default:this.addObject(createObject(2),i)}else this.addObject(createObject(2),i)},e.prototype.addGuide=function(e,t){e.components["p-pos"].value=t,e.components["p-origin"].value=Pt.from(t),this.g.push(e)},e.prototype.addSpawner=function(e,t){e.components["p-pos"].value=t,this.s.push(e)},e.prototype.addPlayer=function(e,t){e.components["p-pos"].value=t;var n=t.x+t.y*this.l.s.w;this.l.m[n]|=TMASK.P;var i=this.p.push(e);this.l.m[n]|=i<<this.P_OFF},e.prototype.addObject=function(e,t){e.components["p-pos"].value=t;var n=t.x+t.y*this.l.s.w;this.l.m[n]|=TMASK.O;var i=this.o.push(e);this.l.m[n]|=i<<this.O_OFF},e.prototype.addMarker=function(e,t){e.components["p-pos"].value=t;var n=t.x+t.y*this.l.s.w;this.l.m[n]|=TMASK.M;var i=this.m.push(e);this.l.m[n]|=i<<this.M_OFF},e.prototype.movePlayer=function(e,t){if(this.l.m[e.x+e.y*this.l.s.w]){var n=(this.l.m[e.x+e.y*this.l.s.w]>>this.P_OFF)-1;this.removePlayer(e),void 0==this.l.m[t.x+t.y*this.l.s.w]&&(this.l.m[t.x+t.y*this.l.s.w]=0),this.l.m[t.x+t.y*this.l.s.w]|=n+1<<this.P_OFF,this.l.m[t.x+t.y*this.l.s.w]|=TMASK.P}},e.prototype.removePlayer=function(e){this.l.m[e.x+e.y*this.l.s.w]&=~(15<<this.P_OFF),this.l.m[e.x+e.y*this.l.s.w]&=~TMASK.P},e.prototype.removeMarker=function(e){this.l.m[e.x+e.y*this.l.s.w]&=~(255<<this.M_OFF),this.l.m[e.x+e.y*this.l.s.w]&=~TMASK.M},e.prototype.removeObject=function(e){this.l.m[e.x+e.y*this.l.s.w]&=~(1023<<this.O_OFF),this.l.m[e.x+e.y*this.l.s.w]&=~TMASK.O},e.prototype.playerAt=function(e){return 0!=(this.l.m[e.x+e.y*this.l.s.w]&TMASK.P)},e.prototype.objectAt=function(e){return 0!=(this.l.m[e.x+e.y*this.l.s.w]&TMASK.O)},e.prototype.markerAt=function(e){return 0!=(this.l.m[e.x+e.y*this.l.s.w]&TMASK.M)},e.prototype.getPlayerAt=function(e){if(this.playerAt(e)){var t=(this.l.m[e.x+e.y*this.l.s.w]>>this.P_OFF)-1;return Game.gd.p[t]}},e.prototype.getObjectAt=function(e){if(this.objectAt(e)){var t=((this.l.m[e.x+e.y*this.l.s.w]&~(15<<this.P_OFF))>>this.O_OFF)-1;return Game.gd.o[t]}},e.prototype.getMarkerAt=function(e){if(this.markerAt(e)){var t=((this.l.m[e.x+e.y*this.l.s.w]&~(16383<<this.O_OFF))>>this.M_OFF)-1;return Game.gd.m[t]}},e.prototype.getMarkerIndex=function(e){if(this.markerAt(e))return((this.l.m[e.x+e.y*this.l.s.w]&~(16383<<this.O_OFF))>>this.M_OFF)-1},e.prototype.getCurrPlayer=function(){for(var e in this.p)if(this.p[e].components.input&&!0===this.p[e].components.input.value)return this.p[e]},e}(),Camera=function(){return function(e,t){this.p=e,this.s=t}}(),cP=function(e){function t(t,n){void 0===n&&(n=new Pt);var i=e.call(this,"p-"+t)||this;return i.value=n,i}return __extends(t,e),t}(Component),cSprite=function(e){function t(t){var n=e.call(this,"sprite")||this;return n.r=0,n.value=t,n}return __extends(t,e),t}(Component),cTag=function(e){function t(t,n){var i=e.call(this,t)||this;return i.value=n,i}return __extends(t,e),t}(Component),cFlag=function(e){function t(t,n){var i=e.call(this,t)||this;return i.value=n,i}return __extends(t,e),t}(Component),cLight=function(e){function t(t){var n=e.call(this,"light")||this;return n.value=t,n}return __extends(t,e),t}(Component),cSound=function(e){function t(t,n){var i=e.call(this,"s-"+t)||this;return i.value=n,i}return __extends(t,e),t}(Component),cTimer=function(e){function t(t,n){var i=e.call(this,"t-"+t)||this;return i.cur=0,i.value=n,i}return __extends(t,e),t}(Component),TMASK;!function(e){e.W=1,e.O=2,e.M=4,e.P=8,e.FLOOR=16,e.WALL=32,e.S_WALL=64}(TMASK||(TMASK={}));var Level=function(){function e(e){void 0===e&&(e=new Dm(50,50)),this.m=[],this.r=!0,this.s=e,this.rc=document.createElement("canvas"),this.rc.width=e.w*Game.T_S,this.rc.height=e.h*Game.T_S,this.ctx=this.rc.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}return e.prototype.calcOrigin=function(e,t){var n=t.w===WALL.N,i=t.w===WALL.S,s=t.w===WALL.E,a=t.w===WALL.W,r=t.p.x-(n||i?~~(e.s.w/2):0)+(s?1:0)-(a?e.s.w:0),o=t.p.y-(s||a?~~(e.s.h/2):0)+(n?0:i?1:0)-(n?e.s.h:0);return new Pt(r,o)},e.prototype.addDoor=function(e,t){this.m[t.p.x+t.p.y*this.s.h]=TMASK.FLOOR|TMASK.W,t.w===WALL.N||t.w===WALL.S?(this.m[t.p.x-1+t.p.y*this.s.h]=TMASK.WALL|TMASK.S_WALL,this.m[t.p.x+1+t.p.y*this.s.h]=TMASK.WALL|TMASK.S_WALL,this.m[t.p.x+(t.p.y-1)*this.s.h]=TMASK.FLOOR|TMASK.W,this.m[t.p.x+(t.p.y+1)*this.s.h]=TMASK.FLOOR|TMASK.W):(this.m[t.p.x-1+t.p.y*this.s.h]=TMASK.FLOOR|TMASK.W,this.m[t.p.x+1+t.p.y*this.s.h]=TMASK.FLOOR|TMASK.W,this.m[t.p.x+(t.p.y-1)*this.s.h]=TMASK.WALL,this.m[t.p.x-1+(t.p.y-1)*this.s.h]=TMASK.WALL,this.m[t.p.x+1+(t.p.y-1)*this.s.h]=TMASK.WALL,this.m[t.p.x+(t.p.y+1)*this.s.h]=TMASK.WALL|TMASK.S_WALL)},e.prototype.scan=function(e,t){var n=!0,i=t.w===WALL.N,s=t.w===WALL.S,a=t.w===WALL.E,r=t.w===WALL.W,o=this.calcOrigin(e,t),h=o.x,p=o.y,u=e.s.w+(a||r?1:0),m=e.s.h+(i||s?1:0);n=h>0&&p>0&&h<this.s.w-e.s.w&&p<this.s.h-e.s.h;for(var c=h;c<h+u&&n;c++)for(var l=p;l<p+m&&n;l++)n=n&&void 0===this.m[c+l*this.s.h];return n},e.prototype.roomToMap=function(e,t){e.p.x=t.x,e.p.y=t.y;for(var n=t.x,i=0;i<e.s.w;i++){for(var s=t.y,a=0;a<e.s.h;a++)0===a&&0!==i&&i!==e.s.w-1?this.m[n+s*this.s.h]=TMASK.WALL:0===i||0===a||i===e.s.w-1||a===e.s.h-1?this.m[n+s*this.s.h]=TMASK.WALL|TMASK.S_WALL:this.m[n+s*this.s.h]=TMASK.FLOOR|TMASK.W,s++;n++}},e.prototype.generate=function(){var e,t,n,i,s,a=[],r=new Pt;for(e=n=Room.makeRoom(25,25),r=new Pt(randomInt(0,this.s.w-e.s.w),randomInt(0,this.s.h-e.s.h)),a.push(e),this.roomToMap(e,r),Game.gd.addRandObj(r,e.s);a.length>0;){for(;n.w.length>0&&null!==(i=n.getRandomWall());)if(t=Room.makeCorridor(i.w===WALL.N||i.w===WALL.S),this.scan(t,i))for(r=this.calcOrigin(t,i),this.roomToMap(t,r),this.addDoor(t,i);t.w.length>0&&(e=Room.makeRoom(25,25),null!==(s=t.getRandomWall()));)this.scan(e,s)&&(r=this.calcOrigin(e,s),this.roomToMap(e,r),this.addDoor(e,s),Game.gd.addRandObj(r,e.s),a.push(e),n=e);a.length>1?(a.pop(),n=a[a.length-1]):a.pop()}},e.prototype.render=function(e){var t=this,n=randomized([0,1,1,2]),i=randomized([0,0,0,0,0,0,1,2]);this.m.forEach(function(s,a){var r,o=~~(a/t.s.w),h=a%t.s.w;s?s&TMASK.WALL?r=s&TMASK.S_WALL?SSM.spriteSheet("wall").sprites[3]:SSM.spriteSheet("wall").sprites[n()]:s&TMASK.FLOOR&&(r=SSM.spriteSheet("floor").sprites[i()]):(e.fillStyle="#000000",e.fillRect(h*Game.T_S,o*Game.T_S,Game.T_S,Game.T_S)),r&&e.drawImage(r,0,0,Game.T_S,Game.T_S,~~(h*Game.T_S),~~(o*Game.T_S),Game.T_S,Game.T_S)})},e.prototype.draw=function(e,t){this.r&&(this.render(this.ctx),this.r=!1),e.globalAlpha=1,Game.gd.DEBUG?e.drawImage(this.rc,~~(t.p.x*Game.T_S),~~(t.p.y*Game.T_S),~~(t.s.w*Game.T_S),~~(t.s.h*Game.T_S),0,0,~~(Game.T_W*Game.T_S),~~(Game.T_H*Game.T_S)):e.drawImage(this.rc,~~(t.p.x*Game.T_S),~~(t.p.y*Game.T_S),~~(t.s.w*Game.T_S),~~(t.s.h*Game.T_S),0,0,~~(t.s.w*Game.T_S*2),~~(t.s.h*Game.T_S*2))},e}(),Light=function(){function e(e,t,n){this.p=e,this.i=t,this.r=n}return e.prototype.calc=function(t,n){this.a=[];var i=e.poc(this.p.x,this.p.y,this.r);for(var s in i){var a=e.pol(this.p.x,this.p.y,i[s].x,i[s].y),r=this.i/a.length,o=0;for(var h in a){if(a[h].x<0||a[h].x>=n.w||a[h].y<0||a[h].y>=n.h)break;var p=a[h].y*n.w+a[h].x,u=r*(a.length-parseInt(h));if(t[p]&TMASK.FLOOR&&o>0)break;if(p in this.a&&!(this.a[p]>u)||(this.a[p]=1-(u>1?1:u)),t[p]&TMASK.S_WALL)break;if(t[p]&TMASK.WALL&&o>1)break;if(t[p]&TMASK.WALL&&o++,!t[p])break}}},e.reLM=function(e,t){var n=[];for(var i in e)for(var s in e[i].a)(!n[s]||n[s]>e[i].a[s])&&(n[s]=e[i].a[s]);return n},e.pol=function(e,t,n,i){var s=[],a=Math.abs(n-e),r=Math.abs(i-t),o=e,h=t,p=1+a+r,u=e<n?1:-1,m=t<i?1:-1,c=a-r;for(a*=2,r*=2;p>0;)s.push(new Pt(o,h)),c>0?(o+=u,c-=r):(h+=m,c+=a),p-=1;return s},e.poc=function(e,t,n){for(var i=[],s=n,a=0,r=~~(1-s);a<=s;)i.push(new Pt(s+e,a+t)),i.push(new Pt(a+e,s+t)),i.push(new Pt(-s+e,a+t)),i.push(new Pt(-a+e,s+t)),i.push(new Pt(-s+e,-a+t)),i.push(new Pt(-a+e,-s+t)),i.push(new Pt(s+e,-a+t)),i.push(new Pt(a+e,-s+t)),a+=1,r+=r<=0?2*a+1:2*(a-(s-=1))+1;return i},e}(),WALL;!function(e){e[e.N=0]="N",e[e.E=1]="E",e[e.S=2]="S",e[e.W=3]="W"}(WALL||(WALL={}));var ROOMTYPE;!function(e){e[e.CORRIDOR=0]="CORRIDOR",e[e.ROOM=1]="ROOM"}(ROOMTYPE||(ROOMTYPE={}));var Room=function(){function e(e,t,n,i){void 0===e&&(e=new Pt),void 0===t&&(t=new Dm),void 0===n&&(n=ROOMTYPE.ROOM),void 0===i&&(i=[WALL.N,WALL.E,WALL.S,WALL.W]),this.p=e,this.s=t,this.w=i,this.t=n,this.w=shuffle(this.w)}return e.prototype.getRandomWall=function(){if(0===this.w.length)return null;var e=this.w.pop(),t=new Pt;return e===WALL.N?(t.x=this.p.x+Math.floor(this.s.w/2),t.y=this.p.y-1):e===WALL.S?(t.x=this.p.x+Math.floor(this.s.w/2),t.y=this.p.y+this.s.h):e===WALL.W?(t.x=this.p.x-1,t.y=this.p.y+Math.floor(this.s.h/2)):e===WALL.E&&(t.x=this.p.x+this.s.w,t.y=this.p.y+Math.floor(this.s.h/2)),{p:t,w:e}},e.makeRoom=function(t,n){return new e(new Pt,new Dm(randomInt(7,t),randomInt(7,n)),ROOMTYPE.ROOM)},e.makeCorridor=function(t){return new e(new Pt,new Dm(t?5:randomInt(9,17),t?randomInt(9,17):5),ROOMTYPE.CORRIDOR)},e}(),diff;!function(e){e[e.EASY=0]="EASY",e[e.NORMAL=1]="NORMAL",e[e.HARD=2]="HARD",e[e.VHARD=3]="VHARD"}(diff||(diff={}));var GameScreen=function(e){function t(){var t=e.call(this)||this;return t.mt=0,t.ma=1,t.md=-.15,t.c=new Camera(new Pt,new Dm(32,17)),t}return __extends(t,e),t.prototype.transitionIn=function(){this.requestingClear=!0,e.prototype.transitionIn.call(this)},t.prototype.transitionOut=function(){e.prototype.transitionOut.call(this)},t.prototype.update=function(e){if(Input.KB.wasDown(Input.KB.KEY.C)){Game.gd.DEBUG=!Game.gd.DEBUG,Game.gd.DEBUG?(this.c.s.w=Game.T_W,this.c.s.h=Game.T_H):(this.c.s.w=32,this.c.s.h=17);s=Pt.from(Game.gd.getCurrPlayer().components["p-pos"].value);this.c.p.x=s.x-~~(this.c.s.w/2),this.c.p.y=s.y-~~(this.c.s.h/2),this.redraw=!0}Game.gd.p.length,this.mt+=e,this.mt>=250&&(this.mt=0,this.ma+=this.md,(this.ma>=1||this.ma<=.55)&&(this.md*=-1),this.redraw=!0);for(var t in Game.gd.s)spawn(Game.gd.s[t]);for(var t in Game.gd.p){var n=Game.gd.p[t].components,i=Game.gd.p[t];if(!Game.gd.getCurrPlayer()){n.input.value=!0;s=Pt.from(Game.gd.getCurrPlayer().components["p-pos"].value);this.c.p.x=s.x-~~(this.c.s.w/2),this.c.p.y=s.y-~~(this.c.s.h/2)}if(n.input&&n.input.value&&n["t-move"]&&((o=n["t-move"]).cur+=e,o.cur>=o.value&&n["p-move"]&&input(i)&&(o.cur=0,n["p-pos"]&&!collision(i,Game.gd.l)&&(n.sprite&&animate(i),movement(i))))){this.redraw=!0;var s=n["p-pos"].value;if(this.c.p.x=s.x-~~(this.c.s.w/2),this.c.p.y=s.y-~~(this.c.s.h/2),Game.gd.objectAt(s)){var a=Game.gd.getObjectAt(s);switch(a.components.type.value){case"gold":Game.i.ae.beep(new Beep(2500,2500,"square",.75,1)),pickup(a);break;case"chest":Game.i.ae.beep(new Beep(635,3,"square",.1,1)),pickup(a);break;case"switch":activate(a);break;case"exit":exit(i)}}else n["s-move"]&&Game.i.ae.beep(n["s-move"].value)}}for(var t in Game.gd.g){var n=Game.gd.g[t].components,r=Game.gd.g[t],o=n["t-move"];o.cur+=e,o.cur>=o.value&&(o.cur=0,guideMove(r),this.redraw=!0)}if(this.redraw){Game.gd.lights.length=0;for(var t in Game.gd.p)(n=Game.gd.p[t].components).light&&n["p-pos"]&&((h=n.light.value).p=n["p-pos"].value,h.calc(Game.gd.l.m,Game.gd.l.s),Game.gd.lights.push(h));for(var t in Game.gd.g)(n=Game.gd.g[t].components).light&&n["p-pos"]&&((h=n.light.value).p=n["p-pos"].value,h.calc(Game.gd.l.m,Game.gd.l.s),Game.gd.lights.push(h));for(var t in Game.gd.m)if((n=Game.gd.m[t].components).light&&n["p-pos"]){var h=n.light.value;h.p=n["p-pos"].value,h.calc(Game.gd.l.m,Game.gd.l.s),Game.gd.lights.push(h)}Game.gd.lights.length>0&&(Game.gd.lm=Light.reLM(Game.gd.lights,Game.gd.l.s))}Input.KB.wasBindDown(Input.KB.META_KEY.ACTION)&&Game.i.e.gsm.push("marker-menu"),this.requestingClear=this.redraw},t.prototype.draw=function(e){var t=this;if(this.redraw)if(Game.gd.l.draw(e,this.c),Game.gd.DEBUG){Game.gd.m.forEach(function(n){var i=n.components.sprite.value,s=n.components["p-pos"].value;e.drawImage(i,0,0,Game.T_S,Game.T_S,~~((s.x-t.c.p.x)*Game.T_S),~~((s.y-t.c.p.y)*Game.T_S),Game.T_S,Game.T_S)}),Game.gd.o.forEach(function(n){var i=n.components.sprite.value,s=n.components["p-pos"].value;e.drawImage(i,0,0,Game.T_S,Game.T_S,~~((s.x-t.c.p.x)*Game.T_S),~~((s.y-t.c.p.y)*Game.T_S),Game.T_S,Game.T_S)}),Game.gd.p.forEach(function(n){var i=n.components.sprite.value,s=n.components["p-pos"].value;e.drawImage(i,0,0,Game.T_S,Game.T_S,~~((s.x-t.c.p.x)*Game.T_S),~~((s.y-t.c.p.y)*Game.T_S),Game.T_S,Game.T_S)}),e.globalAlpha=.7;for(var n=new Pt,i=this.c.p.x;i<this.c.p.x+this.c.s.w;i++)for(var s=this.c.p.y;s<this.c.p.y+this.c.s.h;s++)n.x=i,n.y=s,Game.gd.l.m[i+s*Game.gd.l.s.w]&TMASK.W?e.fillStyle="green":e.fillStyle="red",Game.gd.markerAt(n)&&(e.fillStyle="yellow"),Game.gd.objectAt(n)&&(e.fillStyle="blue"),Game.gd.playerAt(n)&&(e.fillStyle="orange"),e.fillRect(~~(i-this.c.p.x)*Game.T_S+2,~~(s-this.c.p.y)*Game.T_S+2,4,4);e.globalAlpha=1}else{e.globalAlpha=this.ma,Game.gd.m.forEach(function(n){drawEnt(e,n,t.c)}),e.globalAlpha=1,Game.gd.o.forEach(function(n){drawEnt(e,n,t.c)}),Game.gd.p.forEach(function(n){drawEnt(e,n,t.c)}),e.globalAlpha=.3,Game.gd.g.forEach(function(n){drawEnt(e,n,t.c)}),e.globalAlpha=1,e.fillStyle="white",e.textAlign="left",e.font="11px sans-serif",drawSpr(e,SSM.spriteSheet("marker").sprites[0],new Pt(.5,17.5),2),drawSpr(e,SSM.spriteSheet("marker").sprites[1],new Pt(1.5,17.5),2),e.fillText(" x "+Game.gd.markers,4*Game.T_S,Game.P_H-2);var a=0;for(var r in Game.gd.p)drawSpr(e,SSM.spriteSheet("sprites").sprites[0],new Pt(4.5+1*a,17.5),2),a++;if(e.textAlign="right",e.fillText("$"+Game.gd.score.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),Game.P_W-2,Game.P_H-2),Game.gd.lm.length>0){e.fillStyle="#0d0d0d";for(var o=this.c.p.x,h=0;o<this.c.p.x+this.c.s.w;o++){for(var p=this.c.p.y,u=0;p<this.c.p.y+this.c.s.h;p++){var m=Game.gd.lm[o+p*Game.gd.l.s.h];e.globalAlpha=m||1,e.fillRect(h*Game.T_S*2,u*Game.T_S*2,2*Game.T_S,2*Game.T_S),u++}h++}e.globalAlpha=1}}},t}(GameState),MainMenu=function(e){function t(){var t=e.call(this)||this;return t.selectedIndex=0,t.subIndex=0,t.menuOptions=["New Game","Quit"],t.subMenuOptions=["Easy","Normal","Lost","Forsaken"],t}return __extends(t,e),t.prototype.transitionIn=function(){this.requestingClear=!0,this.selectedIndex=0,this.subMenu=!1,this.subIndex=0,e.prototype.transitionIn.call(this)},t.prototype.transitionOut=function(){this.requestingClear=!0,e.prototype.transitionIn.call(this)},t.prototype.update=function(e){if(Input.KB.wasDown(Input.KB.KEY.ESC))this.subMenu=!1,this.redraw=!0;else if(Input.KB.wasBindDown(Input.KB.META_KEY.ACTION))if(this.subMenu){switch(this.subIndex){case 0:Game.gd.setupGame(diff.EASY);break;case 1:Game.gd.setupGame(diff.NORMAL);break;case 2:Game.gd.setupGame(diff.HARD);break;case 3:Game.gd.setupGame(diff.VHARD);break;default:Game.gd.setupGame(diff.EASY)}Game.i.e.gsm.push("game-screen")}else switch(this.selectedIndex){case 0:this.subMenu=!0,this.redraw=!0;break;default:window.location.reload()}Input.KB.wasBindDown(Input.KB.META_KEY.DOWN)&&(this.subMenu?this.subIndex=(this.subIndex+1)%this.subMenuOptions.length:this.selectedIndex=(this.selectedIndex+1)%this.menuOptions.length,this.redraw=!0),Input.KB.wasBindDown(Input.KB.META_KEY.UP)&&(this.subMenu?0===this.subIndex?this.subIndex=this.subMenuOptions.length-1:this.subIndex=(this.subIndex-1)%this.subMenuOptions.length:0===this.selectedIndex?this.selectedIndex=this.menuOptions.length-1:this.selectedIndex=(this.selectedIndex-1)%this.menuOptions.length,this.redraw=!0),this.requestingClear=this.redraw},t.prototype.draw=function(e){if(this.redraw)if(e.globalAlpha=1,e.textAlign="center",e.fillStyle=e.strokeStyle="#DDDDDD",e.lineWidth=2,e.font="30px sans-serif",e.fillStyle="#b71d1d",e.fillText("FORSAKEN",~~(Game.P_W/2|0),64),e.font="11px sans-serif",e.fillStyle="#3f3f3f",e.fillText("FAME. FORTUNE. FREEDOM.",~~(Game.P_W/2|0),74),e.font="12px sans-serif",e.fillText("js13k 2017 entry by David Brad",~~(Game.P_W/2|0),~~(Game.P_H-5)),e.fillStyle="#e8e8e8",this.subMenu){for(t=0;t<this.subMenuOptions.length;t++)e.fillText(this.subMenuOptions[t],~~(Game.P_W/2|0),~~((0|Game.P_H)-36*this.subMenuOptions.length+36*t)-16);e.strokeRect(~~(Game.P_W/2-55),~~(Game.P_H-36*this.subMenuOptions.length+36*this.subIndex-32),110,24)}else{for(var t=0;t<this.menuOptions.length;t++)e.fillText(this.menuOptions[t],~~(Game.P_W/2|0),~~((0|Game.P_H)-36*this.menuOptions.length+36*t)-16);e.strokeRect(~~(Game.P_W/2-55),~~(Game.P_H-36*this.menuOptions.length+36*this.selectedIndex-32),110,24)}},t}(GameState),MarkerMenu=function(e){function t(){var t=e.call(this)||this;return t.selectedIndex=0,t}return __extends(t,e),t.prototype.transitionIn=function(){Input.KB.clearInputQueue(),this.selectedIndex=5,e.prototype.transitionIn.call(this)},t.prototype.transitionOut=function(){Input.KB.clearInputQueue(),e.prototype.transitionIn.call(this)},t.prototype.update=function(e){if(Input.KB.wasDown(Input.KB.KEY.ESC)&&Game.i.e.gsm.pop(),Input.KB.wasBindDown(Input.KB.META_KEY.ACTION)){var t=Pt.from(Game.gd.getCurrPlayer().components["p-pos"].value),n=Game.gd.getMarkerIndex(t);if(void 0!==n&&(delete Game.gd.m[n],Game.gd.removeMarker(t),Game.gd.markers+=1),5!==this.selectedIndex&&Game.gd.markers>0){var i=createMarker(4===this.selectedIndex?1:0,90*this.selectedIndex);Game.gd.addMarker(i,t),Game.gd.markers-=1}Game.i.e.gsm.pop()}Input.KB.wasBindDown(Input.KB.META_KEY.RIGHT)&&(this.selectedIndex=(this.selectedIndex+1)%6,this.redraw=!0),Input.KB.wasBindDown(Input.KB.META_KEY.LEFT)&&(0===this.selectedIndex?this.selectedIndex=5:this.selectedIndex=(this.selectedIndex-1)%6,this.redraw=!0)},t.prototype.draw=function(e){this.redraw&&(e.globalAlpha=1,e.fillStyle="black",e.fillRect(128,112,~~(Game.P_W-256),~~(Game.P_H-240)),drawSpr(e,SSM.spriteSheet("marker").sprites[0],new Pt(10,9),2),drawSpr(e,SSM.spriteSheet("marker").sprites[0],new Pt(12,9),2,90),drawSpr(e,SSM.spriteSheet("marker").sprites[0],new Pt(14,9),2,180),drawSpr(e,SSM.spriteSheet("marker").sprites[0],new Pt(16,9),2,270),drawSpr(e,SSM.spriteSheet("marker").sprites[1],new Pt(18,9),2),e.font="11px sans-serif",e.textAlign="left",e.fillStyle=e.strokeStyle="#FFFFFF",e.fillText("PICKUP",4+~~(39*Game.T_S),~~(18.5*Game.T_S)),e.textAlign="center",e.fillStyle=e.strokeStyle="#FFFFFF",e.fillText("PLACE A MARKER",~~(32*Game.T_S),~~(15.5*Game.T_S)),e.strokeStyle="green",e.lineWidth=2,e.strokeRect((19+4*this.selectedIndex)*Game.T_S-2,17*Game.T_S-2,4+(5===this.selectedIndex?6*Game.T_S:2*Game.T_S),2*Game.T_S+4))},t}(GameState);