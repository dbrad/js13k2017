window.onload=function(t){function e(){var t=new P;return t.addComponent(new N("pos")),t.addComponent(new N("move")),t.addComponent(new U("move",new C(50,5,"sine",.25,1))),t.addComponent(new q("move",125)),t.addComponent(new z(new Q(new L,.75,5))),t.addComponent(new j("input",!1)),t.addComponent(new H(R.spriteSheet("sprites").sprites[0])),t}function i(){var t=new P;return t.addComponent(new N("pos")),t.addComponent(new N("origin")),t.addComponent(new q("move",150)),t.addComponent(new z(new Q(new L,.35,7))),t.addComponent(new H(R.spriteSheet("guide").sprites[0])),t}function n(t,e){void 0===e&&(e=0);var i=new P;i.addComponent(new N("pos"));var n=new H(R.spriteSheet("marker").sprites[t]);return i.addComponent(new z(new Q(new L,.15,4))),n.r=e,i.addComponent(n),i}function s(t){var e=new P;return e.addComponent(new N("pos")),e.addComponent(new Y("type",t)),e.addComponent(new j("done",!1)),e}function r(){var t=new P;return t.addComponent(new N("pos")),t.addComponent(new j("active",!1)),t.addComponent(new H(R.spriteSheet("guide").sprites[1])),t.addComponent(new Y("type","switch")),t.addComponent(new U("interact",new C(1900,1,"square",.1,1))),t}function o(t){var e=new P;e.addComponent(new N("pos")),e.addComponent(new H(R.spriteSheet("objects").sprites[t])),e.addComponent(new U("collide",new C(50,5,"sine",.25,1)));var i=function(t){switch(t){case 0:return"exit";case 1:return"chest";case 2:return"gold";default:return"unknown"}}(t);return e.addComponent(new Y("type",i)),e}function h(t){var e,i=t.components["p-move"].value;return i.x=i.y=0,b.KB.isBindDown(b.KB.META_KEY.UP)&&(i.y-=1,e=!0),b.KB.isBindDown(b.KB.META_KEY.DOWN)&&(i.y+=1,e=!0),b.KB.isBindDown(b.KB.META_KEY.LEFT)&&(i.x-=1,e=!0),b.KB.isBindDown(b.KB.META_KEY.RIGHT)&&(i.x+=1,e=!0),e}function a(t){var e=O.gd.p.indexOf(t);-1!==e&&(O.gd.removePlayer(L.from(t.components["p-pos"].value)),delete O.gd.p[e],O.gd.players-=1)}function u(t){var e=t.components;e.active&&!1===e.active.value&&(e.active.value=!0,e.sprite.value=R.spriteSheet("guide").sprites[2],O.i.ae.beep(e["s-interact"].value),O.gd.addSpawner(s("guide"),L.from(e["p-pos"].value)))}function p(t){var n=t.components,s=L.from(n["p-pos"].value);switch(n.type.value){case"player":O.gd.addPlayer(e(),s);break;case"guide":O.gd.addGuide(i(),s)}var r=O.gd.s.indexOf(t);-1!==r&&delete O.gd.s[r]}function c(t){var e=O.gd.o.indexOf(t);if(-1!==e)switch(O.gd.removeObject(L.from(t.components["p-pos"].value)),delete O.gd.o[e],t.components.type.value){case"chest":O.gd.score+=1e5;break;case"gold":O.gd.score+=1e3}}function l(t,e){var i=t.components,n=i["p-pos"].value,s=i["p-move"].value,r=new L(s.x,s.y),o=!1;return e.m[n.x+s.x+(n.y+s.y)*e.s.w]&D.W&&!O.gd.playerAt(new L(n.x+s.x,n.y+s.y))||(s.x=s.y=0,o=!0),0!==r.x&&e.m[n.x+r.x+n.y*e.s.w]&D.W&&!O.gd.playerAt(new L(n.x+r.x,n.y))?(s.x=r.x,o=!1):0!==r.y&&e.m[n.x+(n.y+r.y)*e.s.w]&D.W&&!O.gd.playerAt(new L(n.x,n.y+r.y))&&(s.y=r.y,o=!1),o}function d(t){var e=t.components,i=e.sprite,n=e["p-move"].value;0===n.x&&0===n.y||(1===n.x?i.r+=90:-1===n.x?i.r-=90:-1!==n.y&&1!==n.y||i.r%180==0?-1!==n.y&&1!==n.y||i.r%180!=0||(i.r+=180):i.r=0,1===Math.abs(i.r%360)&&(i.r=0))}function f(t){var e=t.components,i=e["p-pos"],n=e["p-move"].value;if(0!==n.x||0!==n.y){var s=L.from(i.value);return i.value.x+=n.x,i.value.y+=n.y,O.gd.movePlayer(s,i.value),n.x=n.y=0,!0}return!1}function m(t){var e=t.components,i=O.gd.exit.components["p-pos"].value,n=e["p-pos"].value,s=i.x-n.x,r=i.y-n.y,o=Math.abs(s),h=Math.abs(r);0==s&&0==r?e["p-pos"].value=L.from(e["p-origin"].value):0!==o&&0!==h?(n.x+=s>0?1:-1,n.y+=r>0?1:-1):0!==o?n.x+=s>0?1:-1:0!==h&&(n.y+=r>0?1:-1);var a=e.sprite;a.r+=15,360==a.r&&(a.r=0)}function w(t,e,i){var n=e.components["p-pos"].value;if(n.x>=i.p.x&&n.x<i.p.x+i.s.w&&n.y>=i.p.y&&n.y<i.p.y+i.s.h){var s=e.components.sprite,r=s.value;t.save(),t.translate(~~((n.x-i.p.x)*O.T_S*2)+O.T_S,~~((n.y-i.p.y)*O.T_S*2)+O.T_S),t.rotate(s.r*Math.PI/180),t.drawImage(r,0,0,O.T_S,O.T_S,-O.T_S,-O.T_S,2*O.T_S,2*O.T_S),t.restore()}}function g(t,e,i,n,s){void 0===n&&(n=1),void 0===s&&(s=0),t.save(),t.translate(~~(i.x*O.T_S*n),~~(i.y*O.T_S*n)),t.rotate(s*Math.PI/180),t.drawImage(e,0,0,O.T_S,O.T_S,-O.T_S,-O.T_S,O.T_S*n,O.T_S*n),t.restore()}function y(t,e){return Math.floor(Math.random()*(e-t+1))+t}function v(t,e){void 0===e&&(e=!0);var i=t,n=e,s=x(i);return function(){if(0===s.length&&n)s=x(i);else if(0===s.length&&!n)return;return s.pop()}}function x(t){for(var e,i,n=t.length,s=t.slice();0!==n;)i=Math.floor(Math.random()*n),e=s[n-=1],s[n]=s[i],s[i]=e;return s}function S(t,e,i,n){return t.x>=e.x-n&&t.x<=e.x+i.w+n&&t.y>=e.y-10&&t.y<=e.y+i.h+n}var b,_=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();!function(t){!function(t){var e;!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE",t[t.NUM_1=49]="NUM_1",t[t.NUM_2=50]="NUM_2",t[t.NUM_3=51]="NUM_3",t[t.NUM_4=52]="NUM_4",t[t.NUM_5=53]="NUM_5",t[t.C=67]="C",t[t.ESC=27]="ESC"}(e=t.KEY||(t.KEY={}));var i;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t[t.ACTION=4]="ACTION"}(i=t.META_KEY||(t.META_KEY={})),t.KEY_BIND=[],t.KEY_BIND[i.UP]=[e.W,e.UP],t.KEY_BIND[i.DOWN]=[e.S,e.DOWN],t.KEY_BIND[i.LEFT]=[e.A,e.LEFT],t.KEY_BIND[i.RIGHT]=[e.D,e.RIGHT],t.KEY_BIND[i.ACTION]=[e.SPACE,e.ENTER];for(var n=[],s=[],r=[],o=0;o<256;o++)s[o]=!0;t.isDown=function(t){return n[t]},t.wasDown=function(t){var e=r[t];return r[t]=!1,e},t.clearInputQueue=function(){for(var t in r)r[t]=!1},t.keyDown=function(t){var e=t.which;n[e]=!0,s[e]&&(r[e]=!0),s[e]=!1},t.keyUp=function(t){var e=t.which;n[e]=!1,s[e]=!0},t.isBindDown=function(e){for(var i=!1,s=0,r=t.KEY_BIND[e];s<r.length;s++){var o=r[s];i=i||n[o]}return i},t.wasBindDown=function(e){for(var i=!1,n=0,s=t.KEY_BIND[e];n<s.length;n++){var o=s[n];i=i||r[o],r[o]=!1}return i}}(t.KB||(t.KB={}))}(b||(b={}));var O=function(){function t(){}return Object.defineProperty(t,"i",{get:function(){return t._i||(t._i=new t),t._i},enumerable:!0,configurable:!0}),Object.defineProperty(t,"gd",{get:function(){return t.i._gc||(t.i._gc=new B),t.i._gc},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e,i){this._c=e,this._w=t,this._ac=i,T.Loader.add("sheet","./sheet.png"),T.Loader.load(this.done.bind(this))},t.prototype.done=function(){this.e=new I(this._c),this.bindings(),this.e.gsm.reg("main-menu",new tt),this.e.gsm.reg("game-screen",new Z),this.e.gsm.reg("marker-menu",new et),this.e.gsm.push("main-menu"),this.e.run()},t.prototype.bindings=function(){this._w.addEventListener("resize",this.onResize.bind(this),!1),this.onResize(),this._w.onkeydown=b.KB.keyDown,this._w.onkeyup=b.KB.keyUp,this._w.onblur=this.e.pause.bind(this.e),this._w.onfocus=this.e.unpause.bind(this.e),this.ae=new k(this._ac),R.storeSheet(new W("sheet","sprites",8,0,new F(5,1))),R.storeSheet(new W("sheet","marker",8,0,new F(2,1),new L(8,0))),R.storeSheet(new W("sheet","floor",8,0,new F(3,1),new L(24,0))),R.storeSheet(new W("sheet","wall",8,0,new F(4,1),new L(48,0))),R.storeSheet(new W("sheet","guide",8,0,new F(3,1),new L(0,8))),R.storeSheet(new W("sheet","objects",8,0,new F(3,1),new L(24,8)))},t.prototype.onResize=function(){var t=window.innerWidth/this._c.width,e=window.innerHeight/this._c.height,i=0|Math.min(t,e);i=i<=0?1:i;var n=[this._c.width*i,this._c.height*i],s=[(window.innerWidth-n[0])/2,(window.innerHeight-n[1])/2],r=document.getElementById("stage"),o="translate("+~~s[0]+"px, "+~~s[1]+"px) scale("+~~i+")";r.style.transform=o,r.style.webkitTransform=o},t}();!function(t){t.P_W=512,t.P_H=288,t.T_W=64,t.T_H=36,t.T_S=8}(O||(O={}));var T,E=function(){function t(){this.redraw=!0,this.requestingClear=!1}return t.prototype.transitionIn=function(){this.redraw=!0,this.update(0)},t.prototype.transitionOut=function(){this.redraw=!0,this.update(0)},t}(),A=function(){function t(){this.stateCollection={},this.stateStack=[]}return t.prototype.reg=function(t,e){this.stateCollection[t]=e},Object.defineProperty(t.prototype,"cur",{get:function(){return this.stateStack[this.stateStack.length-1]},enumerable:!0,configurable:!0}),t.prototype.push=function(t){this.cur&&this.cur.transitionOut(),this.stateStack.push(this.stateCollection[t]),this.cur&&this.cur.transitionIn()},t.prototype.pop=function(){this.cur&&this.cur.transitionOut(),this.stateStack.pop(),this.cur&&this.cur.transitionIn()},t}(),I=function(){function t(t){this.clearScreen=!1,this.redraw=!1,this.systemPause=!1,this.screen=t,this.ctx=this.screen.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=this.screen.width,this.buffer.height=this.screen.height,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1,this.bufferCtx.webkitImageSmoothingEnabled=!1,this.gsm=new A}return t.prototype.update=function(t){this.systemPause||this.gsm.cur.update(t)},t.prototype.draw=function(){(this.clearScreen||this.gsm.cur.requestingClear)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.bufferCtx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=this.gsm.cur.requestingClear=!1),this.systemPause||!this.redraw&&!this.gsm.cur.redraw?this.systemPause&&this.redraw&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,O.P_W,O.P_H),this.ctx.globalAlpha=1,this.redraw=this.gsm.cur.redraw=!1):(this.bufferCtx.globalAlpha=1,this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1,this.bufferCtx.webkitImageSmoothingEnabled=!1,this.gsm.cur.draw(this.bufferCtx),this.ctx.globalAlpha=1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.drawImage(this.buffer,0,0,O.P_W,O.P_H,0,0,O.P_W,O.P_H),this.redraw=this.gsm.cur.redraw=!1)},t.prototype.loop=function(){var t=window.performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},t.prototype.run=function(){this.loopHandle=window.requestAnimationFrame(this.loop.bind(this))},t.prototype.stop=function(){window.cancelAnimationFrame(this.loopHandle)},t.prototype.pause=function(){this.systemPause=!0,this.redraw=!0},t.prototype.unpause=function(){this.systemPause=!1,this.gsm.cur.redraw=this.clearScreen=!0},t}(),k=function(){function t(t){this.audioContext=t}return t.prototype.beep=function(t){var e=this.audioContext,i=e.createOscillator(),n=e.createGain(),s=t.vol||1;i.type=t.shape,i.frequency.setValueAtTime(t.freq1,e.currentTime),i.frequency.exponentialRampToValueAtTime(t.freq2,e.currentTime+t.dur/2),i.frequency.exponentialRampToValueAtTime(t.freq1,e.currentTime+t.dur),n.gain.setValueAtTime(s,e.currentTime),n.gain.exponentialRampToValueAtTime(.001,e.currentTime+t.dur),i.connect(n),n.connect(e.destination),i.start(e.currentTime),i.stop(e.currentTime+t.dur)},t}(),C=function(){return function(t,e,i,n,s){this.freq1=t,this.freq2=e,this.shape=i,this.dur=n,this.vol=s}}(),M=function(){return function(t){this.name=t}}(),P=function(){function t(){return this.components={},t.autoID||(t.autoID=0),this.id=t.autoID++,this}return t.prototype.addComponent=function(t){return this.components[t.name]=t,this},t}();!function(t){var e={};t.getTexture=function(t){return e[t]};var i={},n=0;!function(t){t.add=function(t,e){i[t]=e,n++},t.load=function(t){var s={counter:0,loadCount:0,callback:t};for(var r in i)e[r]=new Image,e[r].src=i[r],e[r].onload=function(t){t.counter++===t.loadCount&&t.callback()}.bind(this,s),delete i[r];n=0}}(t.Loader||(t.Loader={}))}(T||(T={}));var R,L=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.from=function(e){var i=new t;return i.x=e.x,i.y=e.y,i},t}(),F=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.w=t,this.h=e}return t.from=function(e,i){return new t(e,i)},t}(),W=function(){function t(t,e,i,n,s,r){void 0===n&&(n=0),void 0===s&&(s=new F(0,0)),void 0===r&&(r=new L(0,0)),this.sprites=[],this.name=e,this.offset=r,this.subsheet=s,this.tileSize=i,this.gutter=n,this.image=T.getTexture(t),this.storeSprites()}return t.prototype.reColourize=function(t,e,i,n,s){for(var r=this.sprites[t].getContext("2d").getImageData(0,0,this.tileSize,this.tileSize),o=0;o<this.tileSize*this.tileSize*4;o+=4)r.data[o]=e||r.data[o],r.data[o+1]=i||r.data[o+1],r.data[o+2]=n||r.data[o+2],r.data[o+3]=s||r.data[o+3];var h=document.createElement("canvas");return h.width=h.height=this.tileSize,h.getContext("2d").putImageData(r,0,0),h},t.prototype.storeSprites=function(t){void 0===t&&(t=null),this.spritesPerRow=0===this.subsheet.w||0===this.subsheet.h?this.image.width/this.tileSize:this.subsheet.w,this.spritesPerCol=0===this.subsheet.w||0===this.subsheet.h?this.image.height/this.tileSize:this.subsheet.h;for(var e,i=0;i<this.spritesPerCol;i++)for(var n=0;n<this.spritesPerRow;n++){var s=(e=this.sprites[n+i*this.spritesPerRow]=document.createElement("canvas")).getContext("2d");s.mozImageSmoothingEnabled=s.webkitImageSmoothingEnabled=s.imageSmoothingEnabled=!1,e.width=this.tileSize,e.height=this.tileSize,s.drawImage(this.image,(this.tileSize+this.gutter)*n+this.offset.x,(this.tileSize+this.gutter)*i+this.offset.y,this.tileSize,this.tileSize,0,0,this.tileSize,this.tileSize)}},t}();!function(t){var e={};t.storeSheet=function(t){e[t.name]=t},t.spriteSheet=function(t){return e[t]}}(R||(R={}));var D,B=function(){function t(){this.p=[],this.m=[],this.o=[],this.s=[],this.g=[],this.lm=[],this.lights=[],this.score=0,this.t_score=0,this.players=0,this.markers=0,this.P_OFF=26,this.O_OFF=16,this.M_OFF=8}return t.prototype.setupGame=function(t){var e,i,n;switch(t){case J.EASY:e=2,i=2,this.markers=10,n=new F(100,100);break;case J.NORMAL:e=2,i=4,this.markers=25,n=new F(175,175);break;case J.HARD:e=4,i=8,this.markers=50,n=new F(250,250);break;case J.VHARD:e=8,i=16,this.markers=100,n=new F(500,500);break;default:e=1,i=2,this.markers=10,n=new F(50,50)}this.players=e,this.p.length=this.o.length=this.m.length=this.g.length=this.s.length=0,this.buildObjBank(e,i,n),this.l=new V(n),this.l.generate()},t.prototype.buildObjBank=function(t,e,i){for(var n=[0],s=~~(i.w*i.h*.001),r=~~(.25*(s-t-e)),o=~~(s-t-e-r),h=0;h<t;h++)n.push(1);for(h=0;h<e;h++)n.push(2);for(h=0;h<r;h++)n.push(3);for(h=0;h<o;h++)n.push(4);this.objectBank=v(n,!1)},t.prototype.addRandObj=function(t,e){var i=parseInt(this.objectBank()),n=new L(y(t.x+1,t.x+e.w-2),y(t.y+1,t.y+e.h-2));if(void 0!==i)switch(i){case 0:this.exit=o(0),this.addObject(this.exit,n);break;case 1:this.addSpawner(s("player"),n);break;case 2:this.addObject(r(),n);break;case 3:this.addObject(o(1),n),this.t_score+=1e5;break;default:this.addObject(o(2),n),this.t_score+=1e3}else this.addObject(o(2),n),this.t_score+=1e3},t.prototype.addGuide=function(t,e){t.components["p-pos"].value=e,t.components["p-origin"].value=L.from(e),this.g.push(t)},t.prototype.addSpawner=function(t,e){t.components["p-pos"].value=e,this.s.push(t)},t.prototype.addPlayer=function(t,e){t.components["p-pos"].value=e;var i=e.x+e.y*this.l.s.w;this.l.m[i]|=D.P;var n=this.p.push(t);this.l.m[i]|=n<<this.P_OFF},t.prototype.addObject=function(t,e){t.components["p-pos"].value=e;var i=e.x+e.y*this.l.s.w;this.l.m[i]|=D.O;var n=this.o.push(t);this.l.m[i]|=n<<this.O_OFF},t.prototype.addMarker=function(t,e){t.components["p-pos"].value=e;var i=e.x+e.y*this.l.s.w;this.l.m[i]|=D.M;var n=this.m.push(t);this.l.m[i]|=n<<this.M_OFF},t.prototype.movePlayer=function(t,e){if(this.l.m[t.x+t.y*this.l.s.w]){var i=(this.l.m[t.x+t.y*this.l.s.w]>>this.P_OFF)-1;this.removePlayer(t),void 0==this.l.m[e.x+e.y*this.l.s.w]&&(this.l.m[e.x+e.y*this.l.s.w]=0),this.l.m[e.x+e.y*this.l.s.w]|=i+1<<this.P_OFF,this.l.m[e.x+e.y*this.l.s.w]|=D.P}},t.prototype.removePlayer=function(t){this.l.m[t.x+t.y*this.l.s.w]&=~(15<<this.P_OFF),this.l.m[t.x+t.y*this.l.s.w]&=~D.P},t.prototype.removeMarker=function(t){this.l.m[t.x+t.y*this.l.s.w]&=~(255<<this.M_OFF),this.l.m[t.x+t.y*this.l.s.w]&=~D.M},t.prototype.removeObject=function(t){this.l.m[t.x+t.y*this.l.s.w]&=~(1023<<this.O_OFF),this.l.m[t.x+t.y*this.l.s.w]&=~D.O},t.prototype.playerAt=function(t){return 0!=(this.l.m[t.x+t.y*this.l.s.w]&D.P)},t.prototype.objectAt=function(t){return 0!=(this.l.m[t.x+t.y*this.l.s.w]&D.O)},t.prototype.markerAt=function(t){return 0!=(this.l.m[t.x+t.y*this.l.s.w]&D.M)},t.prototype.getObjectAt=function(t){if(this.objectAt(t)){var e=((this.l.m[t.x+t.y*this.l.s.w]&~(15<<this.P_OFF))>>this.O_OFF)-1;return O.gd.o[e]}},t.prototype.getMarkerIndex=function(t){if(this.markerAt(t))return((this.l.m[t.x+t.y*this.l.s.w]&~(16383<<this.O_OFF))>>this.M_OFF)-1},t.prototype.getCurrPlayer=function(){for(var t in this.p)if(this.p[t].components.input&&!0===this.p[t].components.input.value)return this.p[t]},t}(),K=function(){return function(t,e){this.p=t,this.s=e}}(),N=function(t){function e(e,i){void 0===i&&(i=new L);var n=t.call(this,"p-"+e)||this;return n.value=i,n}return _(e,t),e}(M),H=function(t){function e(e){var i=t.call(this,"sprite")||this;return i.r=0,i.value=e,i}return _(e,t),e}(M),Y=function(t){function e(e,i){var n=t.call(this,e)||this;return n.value=i,n}return _(e,t),e}(M),j=function(t){function e(e,i){var n=t.call(this,e)||this;return n.value=i,n}return _(e,t),e}(M),z=function(t){function e(e){var i=t.call(this,"light")||this;return i.value=e,i}return _(e,t),e}(M),U=function(t){function e(e,i){var n=t.call(this,"s-"+e)||this;return n.value=i,n}return _(e,t),e}(M),q=function(t){function e(e,i){var n=t.call(this,"t-"+e)||this;return n.cur=0,n.value=i,n}return _(e,t),e}(M);!function(t){t.W=1,t.O=2,t.M=4,t.P=8,t.FLOOR=16,t.WALL=32,t.S_WALL=64}(D||(D={}));var G,V=function(){function t(t){void 0===t&&(t=new F(50,50)),this.m=[],this.r=!0,this.s=t,this.rc=document.createElement("canvas"),this.rc.width=t.w*O.T_S,this.rc.height=t.h*O.T_S,this.ctx=this.rc.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}return t.prototype.calcOrigin=function(t,e){var i=e.w===G.N,n=e.w===G.S,s=e.w===G.E,r=e.w===G.W,o=e.p.x-(i||n?~~(t.s.w/2):0)+(s?1:0)-(r?t.s.w:0),h=e.p.y-(s||r?~~(t.s.h/2):0)+(i?0:n?1:0)-(i?t.s.h:0);return new L(o,h)},t.prototype.addDoor=function(t,e){this.m[e.p.x+e.p.y*this.s.h]=D.FLOOR|D.W,e.w===G.N||e.w===G.S?(this.m[e.p.x-1+e.p.y*this.s.h]=D.WALL|D.S_WALL,this.m[e.p.x+1+e.p.y*this.s.h]=D.WALL|D.S_WALL,this.m[e.p.x+(e.p.y-1)*this.s.h]=D.FLOOR|D.W,this.m[e.p.x+(e.p.y+1)*this.s.h]=D.FLOOR|D.W):(this.m[e.p.x-1+e.p.y*this.s.h]=D.FLOOR|D.W,this.m[e.p.x+1+e.p.y*this.s.h]=D.FLOOR|D.W,this.m[e.p.x+(e.p.y-1)*this.s.h]=D.WALL,this.m[e.p.x-1+(e.p.y-1)*this.s.h]=D.WALL,this.m[e.p.x+1+(e.p.y-1)*this.s.h]=D.WALL,this.m[e.p.x+(e.p.y+1)*this.s.h]=D.WALL|D.S_WALL)},t.prototype.scan=function(t,e){var i=!0,n=e.w===G.N,s=e.w===G.S,r=e.w===G.E,o=e.w===G.W,h=this.calcOrigin(t,e),a=h.x,u=h.y,p=t.s.w+(r||o?1:0),c=t.s.h+(n||s?1:0);i=a>0&&u>0&&a<this.s.w-t.s.w&&u<this.s.h-t.s.h;for(var l=a;l<a+p&&i;l++)for(var d=u;d<u+c&&i;d++)i=i&&void 0===this.m[l+d*this.s.h];return i},t.prototype.roomToMap=function(t,e){t.p.x=e.x,t.p.y=e.y;for(var i=e.x,n=0;n<t.s.w;n++){for(var s=e.y,r=0;r<t.s.h;r++)0===r&&0!==n&&n!==t.s.w-1?this.m[i+s*this.s.h]=D.WALL:0===n||0===r||n===t.s.w-1||r===t.s.h-1?this.m[i+s*this.s.h]=D.WALL|D.S_WALL:this.m[i+s*this.s.h]=D.FLOOR|D.W,s++;i++}},t.prototype.generate=function(){var t,e,i,n,s,r=[],o=new L;for(t=i=X.makeRoom(25,25),o=new L(y(0,this.s.w-t.s.w),y(0,this.s.h-t.s.h)),r.push(t),this.roomToMap(t,o),O.gd.addRandObj(o,t.s);r.length>0;){for(;i.w.length>0&&null!==(n=i.getRandomWall());)if(e=X.makeCorridor(n.w===G.N||n.w===G.S),this.scan(e,n))for(o=this.calcOrigin(e,n),this.roomToMap(e,o),this.addDoor(e,n);e.w.length>0&&(t=X.makeRoom(25,25),null!==(s=e.getRandomWall()));)this.scan(t,s)&&(o=this.calcOrigin(t,s),this.roomToMap(t,o),this.addDoor(t,s),O.gd.addRandObj(o,t.s),r.push(t),i=t);r.length>1?(r.pop(),i=r[r.length-1]):r.pop()}},t.prototype.render=function(t){var e=this,i=v([0,1,1,2]),n=v([0,0,0,0,0,0,1,2]);this.m.forEach(function(s,r){var o,h=~~(r/e.s.w),a=r%e.s.w;s?s&D.WALL?o=s&D.S_WALL?R.spriteSheet("wall").sprites[3]:R.spriteSheet("wall").sprites[i()]:s&D.FLOOR&&(o=R.spriteSheet("floor").sprites[n()]):(t.fillStyle="#000000",t.fillRect(a*O.T_S,h*O.T_S,O.T_S,O.T_S)),o&&t.drawImage(o,0,0,O.T_S,O.T_S,~~(a*O.T_S),~~(h*O.T_S),O.T_S,O.T_S)})},t.prototype.draw=function(t,e){this.r&&(this.render(this.ctx),this.r=!1),t.globalAlpha=1,t.drawImage(this.rc,~~(e.p.x*O.T_S),~~(e.p.y*O.T_S),~~(e.s.w*O.T_S),~~(e.s.h*O.T_S),0,0,~~(e.s.w*O.T_S*2),~~(e.s.h*O.T_S*2))},t}(),Q=function(){function t(t,e,i){this.p=t,this.i=e,this.r=i}return t.prototype.calc=function(e,i){this.a=[];var n=t.poc(this.p.x,this.p.y,this.r);for(var s in n){var r=t.pol(this.p.x,this.p.y,n[s].x,n[s].y),o=this.i/r.length,h=0;for(var a in r){if(r[a].x<0||r[a].x>=i.w||r[a].y<0||r[a].y>=i.h)break;var u=r[a].y*i.w+r[a].x,p=o*(r.length-parseInt(a));if(e[u]&D.FLOOR&&h>0)break;if(u in this.a&&!(this.a[u]>p)||(this.a[u]=1-(p>1?1:p)),e[u]&D.S_WALL)break;if(e[u]&D.WALL&&h>1)break;if(e[u]&D.WALL&&h++,!e[u])break}}},t.reLM=function(t,e){var i=[];for(var n in t)for(var s in t[n].a)(!i[s]||i[s]>t[n].a[s])&&(i[s]=t[n].a[s]);return i},t.pol=function(t,e,i,n){var s=[],r=Math.abs(i-t),o=Math.abs(n-e),h=t,a=e,u=1+r+o,p=t<i?1:-1,c=e<n?1:-1,l=r-o;for(r*=2,o*=2;u>0;)s.push(new L(h,a)),l>0?(h+=p,l-=o):(a+=c,l+=r),u-=1;return s},t.poc=function(t,e,i){for(var n=[],s=i,r=0,o=~~(1-s);r<=s;)n.push(new L(s+t,r+e)),n.push(new L(r+t,s+e)),n.push(new L(-s+t,r+e)),n.push(new L(-r+t,s+e)),n.push(new L(-s+t,-r+e)),n.push(new L(-r+t,-s+e)),n.push(new L(s+t,-r+e)),n.push(new L(r+t,-s+e)),r+=1,o+=o<=0?2*r+1:2*(r-(s-=1))+1;return n},t}();!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W"}(G||(G={}));var $;!function(t){t[t.CORRIDOR=0]="CORRIDOR",t[t.ROOM=1]="ROOM"}($||($={}));var J,X=function(){function t(t,e,i,n){void 0===t&&(t=new L),void 0===e&&(e=new F),void 0===i&&(i=$.ROOM),void 0===n&&(n=[G.N,G.E,G.S,G.W]),this.p=t,this.s=e,this.w=n,this.t=i,this.w=x(this.w)}return t.prototype.getRandomWall=function(){if(0===this.w.length)return null;var t=this.w.pop(),e=new L;return t===G.N?(e.x=this.p.x+Math.floor(this.s.w/2),e.y=this.p.y-1):t===G.S?(e.x=this.p.x+Math.floor(this.s.w/2),e.y=this.p.y+this.s.h):t===G.W?(e.x=this.p.x-1,e.y=this.p.y+Math.floor(this.s.h/2)):t===G.E&&(e.x=this.p.x+this.s.w,e.y=this.p.y+Math.floor(this.s.h/2)),{p:e,w:t}},t.makeRoom=function(e,i){return new t(new L,new F(y(7,e),y(7,i)),$.ROOM)},t.makeCorridor=function(e){return new t(new L,new F(e?5:y(9,17),e?y(9,17):5),$.CORRIDOR)},t}();!function(t){t[t.EASY=0]="EASY",t[t.NORMAL=1]="NORMAL",t[t.HARD=2]="HARD",t[t.VHARD=3]="VHARD"}(J||(J={}));var Z=function(t){function e(){var e=t.call(this)||this;return e.mt=0,e.ma=1,e.md=-.15,e.c=new K(new L,new F(32,17)),e}return _(e,t),e.prototype.transitionIn=function(){this.requestingClear=!0,t.prototype.transitionIn.call(this)},e.prototype.transitionOut=function(){t.prototype.transitionOut.call(this)},e.prototype.update=function(t){O.gd.p.length,this.mt+=t,this.mt>=250&&(this.mt=0,this.ma+=this.md,(this.ma>=1||this.ma<=.55)&&(this.md*=-1),this.redraw=!0);for(var e in O.gd.s)p(O.gd.s[e]);for(var e in O.gd.p){var i=O.gd.p[e].components,n=O.gd.p[e];if(!O.gd.getCurrPlayer()){i.input.value=!0;s=L.from(O.gd.getCurrPlayer().components["p-pos"].value);this.c.p.x=s.x-~~(this.c.s.w/2),this.c.p.y=s.y-~~(this.c.s.h/2)}if(i.input&&i.input.value&&i["t-move"]&&((w=i["t-move"]).cur+=t,w.cur>=w.value&&i["p-move"]&&h(n)&&(w.cur=0,i["p-pos"]&&!l(n,O.gd.l)&&(i.sprite&&d(n),f(n))))){this.redraw=!0;var s=i["p-pos"].value;if(this.c.p.x=s.x-~~(this.c.s.w/2),this.c.p.y=s.y-~~(this.c.s.h/2),O.gd.objectAt(s)){var r=O.gd.getObjectAt(s);switch(r.components.type.value){case"gold":O.i.ae.beep(new C(2500,2500,"square",.75,1)),c(r);break;case"chest":O.i.ae.beep(new C(635,3,"square",.1,1)),c(r);break;case"switch":u(r);break;case"exit":a(n)}}else i["s-move"]&&O.i.ae.beep(i["s-move"].value)}}for(var e in O.gd.g){var i=O.gd.g[e].components,o=O.gd.g[e],w=i["t-move"];w.cur+=t,w.cur>=w.value&&(w.cur=0,m(o),this.redraw=!0)}if(this.redraw){O.gd.lights.length=0;for(var e in O.gd.p)(i=O.gd.p[e].components).light&&i["p-pos"]&&S(i["p-pos"].value,this.c.p,this.c.s,10)&&((g=i.light.value).p=i["p-pos"].value,g.calc(O.gd.l.m,O.gd.l.s),O.gd.lights.push(g));for(var e in O.gd.g)(i=O.gd.g[e].components).light&&i["p-pos"]&&S(i["p-pos"].value,this.c.p,this.c.s,10)&&((g=i.light.value).p=i["p-pos"].value,g.calc(O.gd.l.m,O.gd.l.s),O.gd.lights.push(g));for(var e in O.gd.m)if((i=O.gd.m[e].components).light&&i["p-pos"]&&S(i["p-pos"].value,this.c.p,this.c.s,10)){var g=i.light.value;g.p=i["p-pos"].value,g.calc(O.gd.l.m,O.gd.l.s),O.gd.lights.push(g)}O.gd.lights.length>0&&(O.gd.lm=Q.reLM(O.gd.lights,O.gd.l.s))}b.KB.wasBindDown(b.KB.META_KEY.ACTION)&&O.i.e.gsm.push("marker-menu"),this.requestingClear=this.redraw},e.prototype.draw=function(t){var e=this;if(this.redraw){O.gd.l.draw(t,this.c),t.globalAlpha=this.ma,O.gd.m.forEach(function(i){w(t,i,e.c)}),t.globalAlpha=1,O.gd.o.forEach(function(i){w(t,i,e.c)}),O.gd.p.forEach(function(i){w(t,i,e.c)}),t.globalAlpha=.3,O.gd.g.forEach(function(i){w(t,i,e.c)}),t.globalAlpha=1,t.fillStyle="white",t.textAlign="left",t.font="11px sans-serif",g(t,R.spriteSheet("marker").sprites[0],new L(.5,17.5),2),g(t,R.spriteSheet("marker").sprites[1],new L(1.5,17.5),2),t.fillText(" x "+O.gd.markers,4*O.T_S,O.P_H-4);var i=0;for(var n in O.gd.p)g(t,R.spriteSheet("sprites").sprites[0],new L(4.5+1*i,17.5),2),i++;if(t.textAlign="right",t.fillText("$"+O.gd.score.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),O.P_W-4,O.P_H-4),O.gd.lm.length>0){t.fillStyle="#0d0d0d";for(var s=this.c.p.x,r=0;s<this.c.p.x+this.c.s.w;s++){for(var o=this.c.p.y,h=0;o<this.c.p.y+this.c.s.h;o++){var a=O.gd.lm[s+o*O.gd.l.s.h];t.globalAlpha=a||1,t.fillRect(r*O.T_S*2,h*O.T_S*2,2*O.T_S,2*O.T_S),h++}r++}t.globalAlpha=1}}},e}(E),tt=function(t){function e(){var e=t.call(this)||this;return e.selectedIndex=0,e.subIndex=0,e.menuOptions=["New Game","Quit"],e.subMenuOptions=["Easy","Normal","Lost","Forsaken"],e}return _(e,t),e.prototype.transitionIn=function(){this.requestingClear=!0,this.selectedIndex=0,this.subMenu=!1,this.subIndex=0,t.prototype.transitionIn.call(this)},e.prototype.transitionOut=function(){this.requestingClear=!0,t.prototype.transitionIn.call(this)},e.prototype.update=function(t){if(b.KB.wasDown(b.KB.KEY.ESC))this.subMenu=!1,this.redraw=!0;else if(b.KB.wasBindDown(b.KB.META_KEY.ACTION))if(this.subMenu){switch(this.subIndex){case 0:O.gd.setupGame(J.EASY);break;case 1:O.gd.setupGame(J.NORMAL);break;case 2:O.gd.setupGame(J.HARD);break;case 3:O.gd.setupGame(J.VHARD);break;default:O.gd.setupGame(J.EASY)}O.i.e.gsm.push("game-screen")}else switch(this.selectedIndex){case 0:this.subMenu=!0,this.redraw=!0;break;default:window.location.reload()}b.KB.wasBindDown(b.KB.META_KEY.DOWN)&&(this.subMenu?this.subIndex=(this.subIndex+1)%this.subMenuOptions.length:this.selectedIndex=(this.selectedIndex+1)%this.menuOptions.length,this.redraw=!0),b.KB.wasBindDown(b.KB.META_KEY.UP)&&(this.subMenu?0===this.subIndex?this.subIndex=this.subMenuOptions.length-1:this.subIndex=(this.subIndex-1)%this.subMenuOptions.length:0===this.selectedIndex?this.selectedIndex=this.menuOptions.length-1:this.selectedIndex=(this.selectedIndex-1)%this.menuOptions.length,this.redraw=!0),this.requestingClear=this.redraw},e.prototype.draw=function(t){if(this.redraw)if(t.globalAlpha=1,t.textAlign="center",t.fillStyle=t.strokeStyle="#DDDDDD",t.lineWidth=2,t.font="30px sans-serif",t.fillStyle="#b71d1d",t.fillText("FORSAKEN",~~(O.P_W/2|0),64),t.font="11px sans-serif",t.fillStyle="#3f3f3f",t.fillText("FAME. FORTUNE. FREEDOM.",~~(O.P_W/2|0),74),t.font="12px sans-serif",t.fillText("js13k 2017 entry by David Brad",~~(O.P_W/2|0),~~(O.P_H-5)),t.fillStyle="#e8e8e8",this.subMenu){for(e=0;e<this.subMenuOptions.length;e++)t.fillText(this.subMenuOptions[e],~~(O.P_W/2|0),~~((0|O.P_H)-36*this.subMenuOptions.length+36*e)-16);t.strokeRect(~~(O.P_W/2-55),~~(O.P_H-36*this.subMenuOptions.length+36*this.subIndex-32),110,24)}else{for(var e=0;e<this.menuOptions.length;e++)t.fillText(this.menuOptions[e],~~(O.P_W/2|0),~~((0|O.P_H)-36*this.menuOptions.length+36*e)-16);t.strokeRect(~~(O.P_W/2-55),~~(O.P_H-36*this.menuOptions.length+36*this.selectedIndex-32),110,24)}},e}(E),et=function(t){function e(){var e=t.call(this)||this;return e.selectedIndex=0,e}return _(e,t),e.prototype.transitionIn=function(){b.KB.clearInputQueue(),this.selectedIndex=5,t.prototype.transitionIn.call(this)},e.prototype.transitionOut=function(){b.KB.clearInputQueue(),t.prototype.transitionIn.call(this)},e.prototype.update=function(t){if(b.KB.wasDown(b.KB.KEY.ESC)&&O.i.e.gsm.pop(),b.KB.wasBindDown(b.KB.META_KEY.ACTION)){var e=L.from(O.gd.getCurrPlayer().components["p-pos"].value),i=O.gd.getMarkerIndex(e);if(void 0!==i&&(delete O.gd.m[i],O.gd.removeMarker(e),O.gd.markers+=1),5!==this.selectedIndex&&O.gd.markers>0){var s=n(4===this.selectedIndex?1:0,90*this.selectedIndex);O.gd.addMarker(s,e),O.gd.markers-=1}O.i.e.gsm.pop()}b.KB.wasBindDown(b.KB.META_KEY.RIGHT)&&(this.selectedIndex=(this.selectedIndex+1)%6,this.redraw=!0),b.KB.wasBindDown(b.KB.META_KEY.LEFT)&&(0===this.selectedIndex?this.selectedIndex=5:this.selectedIndex=(this.selectedIndex-1)%6,this.redraw=!0)},e.prototype.draw=function(t){this.redraw&&(t.globalAlpha=1,t.fillStyle="black",t.fillRect(128,112,~~(O.P_W-256),~~(O.P_H-240)),g(t,R.spriteSheet("marker").sprites[0],new L(10,9),2),g(t,R.spriteSheet("marker").sprites[0],new L(12,9),2,90),g(t,R.spriteSheet("marker").sprites[0],new L(14,9),2,180),g(t,R.spriteSheet("marker").sprites[0],new L(16,9),2,270),g(t,R.spriteSheet("marker").sprites[1],new L(18,9),2),t.font="11px sans-serif",t.textAlign="left",t.fillStyle=t.strokeStyle="#FFFFFF",t.fillText("PICKUP",4+~~(39*O.T_S),~~(18.5*O.T_S)),t.textAlign="center",t.fillStyle=t.strokeStyle="#FFFFFF",t.fillText("PLACE A MARKER",~~(32*O.T_S),~~(15.5*O.T_S)),t.strokeStyle="green",t.lineWidth=2,t.strokeRect((19+4*this.selectedIndex)*O.T_S-2,17*O.T_S-2,4+(5===this.selectedIndex?6*O.T_S:2*O.T_S),2*O.T_S+4))},e}(E),it=new(window.AudioContext||window.webkitAudioContext);O.i.init(window,document.getElementById("gameCanvas"),it)};